<!DOCTYPE html>
<!-- Cache Buster: v2025.01.12.16.45 -->
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyegaman Dashboard - Onward Dominicans (Production)</title>
    <link rel="stylesheet" href="./src/index.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f0f0f0; }
      html.dark ::-webkit-scrollbar-track { background: #2d3748; }
      ::-webkit-scrollbar-thumb { background: #a0a0a0; border-radius: 4px; }
      html.dark ::-webkit-scrollbar-thumb { background: #718096; }
      .fade-in { opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
      .fade-in.visible { opacity: 1; transform: translateY(0); }
      .admin-card { transition: all 0.3s ease; }
      .admin-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
      html.dark .admin-card:hover { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
      .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
      .stat-card.green { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
      .stat-card.orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
      .stat-card.purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
      .login-container { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
      .admin-table { border-collapse: separate; border-spacing: 0; }
      .admin-table th { position: sticky; top: 0; z-index: 10; }
      .btn-primary { transition: all 0.3s ease; }
      .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
      .sidebar-item { transition: all 0.2s ease; }
      .sidebar-item:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateX(4px); }
      .sidebar-item.active { background-color: rgba(255, 255, 255, 0.2); border-right: 3px solid #fbbf24; }
      .editor-btn { padding: 8px; border-radius: 6px; background-color: transparent; color: #64748b; transition: all 0.2s ease; border: none; cursor: pointer; }
      .editor-btn:hover { background-color: rgba(100, 116, 139, 0.1); color: #334155; }
      html.dark .editor-btn { color: #94a3b8; }
      html.dark .editor-btn:hover { background-color: rgba(148, 163, 184, 0.1); color: #e2e8f0; }
      .editor-btn.active { background-color: #fbbf24; color: white; }
      .editor-select { font-size: 0.875rem; min-width: 100px; }
      .editor-fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: white; }
      html.dark .editor-fullscreen { background: #1e293b; }
      .editor-content { transition: all 0.3s ease; }
      .editor-content.html-mode { font-family: 'Courier New', monospace; background-color: #f8fafc; }
      html.dark .editor-content.html-mode { background-color: #0f172a; color: #e2e8f0; }
      [contenteditable="true"]:empty:before { content: attr(placeholder); color: #9ca3af; font-style: italic; }
      [contenteditable="true"]:focus { outline: none; }
      .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .toast { position: fixed; top: 20px; right: 20px; z-index: 1000; min-width: 300px; }
      .toast.show { animation: slideIn 0.3s ease-out; }
      .toast.hide { animation: slideOut 0.3s ease-in; }
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

      /* Featured article selector styles */
      .article-item { transition: all 0.2s ease; }
      .article-item:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
      .dark .article-item:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }

      /* Line clamp utility */
      .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Gallery Item Editor Modal -->
    <div id="gallery-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 id="gallery-editor-modal-title" class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add Gallery Event</h2>
                <button onclick="adminDashboard.closeGalleryEditor()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="gallery-editor-form" class="space-y-6">
                    <!-- Title -->
                    <div>
                        <label for="gallery-title" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Title *
                        </label>
                        <input type="text" id="gallery-title" name="title" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Enter image title">
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="gallery-description" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Description
                        </label>
                        <textarea id="gallery-description" name="description" rows="3"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Enter image description"></textarea>
                    </div>

                    <!-- Multiple Images Section -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Event Images *
                        </label>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Add multiple images for this event. The first image will be the main/cover image.</p>

                        <!-- Images Container -->
                        <div id="images-container" class="space-y-4">
                            <!-- First Image (Main) -->
                            <div class="image-input-group border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-700" data-index="0">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-medium text-slate-800 dark:text-slate-200">📸 Main Image (Cover)</h4>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Image URL *</label>
                                        <input type="url" name="imageUrl" required
                                            class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm"
                                            placeholder="https://example.com/image1.jpg">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Thumbnail URL (optional)</label>
                                        <input type="url" name="thumbnailUrl"
                                            class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm"
                                            placeholder="https://example.com/thumb1.jpg">
                                    </div>
                                    <div class="image-preview hidden">
                                        <img src="" alt="Preview" class="w-full h-32 object-cover rounded-md border border-slate-200 dark:border-slate-600">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add More Images Button -->
                        <div class="mt-4 flex items-center justify-between">
                            <button type="button" id="add-image-btn" onclick="adminDashboard.addImageInput()"
                                class="flex items-center space-x-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <span>Add Another Image</span>
                            </button>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Maximum 5 images per event</span>
                        </div>
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="gallery-category" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Category
                        </label>
                        <select id="gallery-category" name="categoryId"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                            <option value="">Select a category</option>
                        </select>
                    </div>

                    <!-- Photographer -->
                    <div>
                        <label for="gallery-photographer" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Photographer
                        </label>
                        <input type="text" id="gallery-photographer" name="photographer"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Photographer name">
                    </div>

                    <!-- Location -->
                    <div>
                        <label for="gallery-location" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Location
                        </label>
                        <input type="text" id="gallery-location" name="location"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Photo location">
                    </div>

                    <!-- Date Taken -->
                    <div>
                        <label for="gallery-date-taken" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Date Taken
                        </label>
                        <input type="date" id="gallery-date-taken" name="dateTaken"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                    </div>



                    <!-- Image Preview -->
                    <div id="gallery-image-preview" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Preview
                        </label>
                        <div class="border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-700">
                            <img id="gallery-preview-img" src="" alt="Preview" class="w-full h-48 object-cover rounded-lg">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700">
                <div class="flex items-center space-x-4">
                    <span id="gallery-save-status" class="text-sm text-slate-600 dark:text-slate-400"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="adminDashboard.closeGalleryEditor()"
                        class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="adminDashboard.saveGalleryItem()"
                        class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg btn-primary flex items-center space-x-2">
                        <span id="gallery-save-spinner" class="hidden animate-spin">⏳</span>
                        <span id="gallery-save-btn-text">Save Event</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Category Editor Modal -->
    <div id="gallery-category-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 id="gallery-category-editor-modal-title" class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add Gallery Category</h2>
                <button onclick="adminDashboard.closeGalleryCategoryEditor()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="gallery-category-editor-form" class="space-y-6">
                    <!-- Name -->
                    <div>
                        <label for="gallery-category-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Category Name *
                        </label>
                        <input type="text" id="gallery-category-name" name="name" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Enter category name">
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="gallery-category-description" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Description
                        </label>
                        <textarea id="gallery-category-description" name="description" rows="3"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Enter category description"></textarea>
                    </div>

                    <!-- Color -->
                    <div>
                        <label for="gallery-category-color" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Category Color
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="gallery-category-color" name="color" value="#3B82F6"
                                class="w-12 h-12 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer">
                            <input type="text" id="gallery-category-color-text"
                                class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                                placeholder="#3B82F6" value="#3B82F6">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700">
                <div class="flex items-center space-x-4">
                    <span id="gallery-category-save-status" class="text-sm text-slate-600 dark:text-slate-400"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="adminDashboard.closeGalleryCategoryEditor()"
                        class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="adminDashboard.saveGalleryCategory()"
                        class="px-6 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg btn-primary flex items-center space-x-2">
                        <span id="gallery-category-save-spinner" class="hidden animate-spin">⏳</span>
                        <span id="gallery-category-save-btn-text">Save Category</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Author Editor Modal -->
    <div id="author-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 id="author-editor-modal-title" class="text-2xl font-bold text-slate-800 dark:text-slate-200">Create New Author</h2>
                <button onclick="adminDashboard.closeAuthorEditor()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto">
                <form id="author-editor-form" class="p-6 space-y-6">
                    <!-- Name -->
                    <div>
                        <label for="author-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name *</label>
                        <input type="text" id="author-name" name="name" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-lg font-semibold"
                            placeholder="Enter author's full name...">
                    </div>

                    <!-- Email -->
                    <div>
                        <label for="author-email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address *</label>
                        <input type="email" id="author-email" name="email" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="author@onwarddominicans.news">
                    </div>

                    <!-- Avatar URL -->
                    <div>
                        <label for="author-avatar" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Avatar Image URL</label>
                        <input type="url" id="author-avatar" name="avatarUrl"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="https://example.com/avatar.jpg">
                        <div id="avatar-preview" class="mt-3 hidden">
                            <img id="preview-avatar" src="" alt="Avatar Preview" class="w-24 h-24 object-cover rounded-full border border-slate-200 dark:border-slate-600">
                        </div>
                    </div>

                    <!-- Bio -->
                    <div>
                        <label for="author-bio" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Biography</label>
                        <textarea id="author-bio" name="bio" rows="4" maxlength="500"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Brief biography of the author..."
                            oninput="adminDashboard.updateBioCharCount()"></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Optional - Brief description about the author</p>
                            <span id="bio-char-count" class="text-xs text-slate-500 dark:text-slate-400">0/500</span>
                        </div>
                    </div>

                    <!-- Status -->
                    <div>
                        <label for="author-status" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Status</label>
                        <select id="author-status" name="isActive"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700">
                <div class="flex items-center space-x-4">
                    <span id="author-save-status" class="text-sm text-slate-600 dark:text-slate-400"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="adminDashboard.closeAuthorEditor()"
                        class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="adminDashboard.saveAuthor()"
                        class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg btn-primary flex items-center space-x-2">
                        <span id="author-save-btn-text">Save Author</span>
                        <div id="author-save-spinner" class="hidden spinner"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Article Editor Modal -->
    <div id="article-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 id="editor-modal-title" class="text-2xl font-bold text-slate-800 dark:text-slate-200">Create New Article</h2>
                <button onclick="adminDashboard.closeArticleEditor()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto">
                <form id="article-editor-form" class="p-6 space-y-6">
                    <!-- Title -->
                    <div>
                        <label for="article-title" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Title *</label>
                        <input type="text" id="article-title" name="title" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-lg font-semibold"
                            placeholder="Enter article title...">
                    </div>

                    <!-- Summary -->
                    <div>
                        <label for="article-summary" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Summary *</label>
                        <textarea id="article-summary" name="summary" required rows="3"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Brief summary of the article..."></textarea>
                    </div>

                    <!-- Image URL -->
                    <div>
                        <label for="article-image" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Featured Image URL</label>
                        <input type="url" id="article-image" name="imageUrl"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="https://example.com/image.jpg">
                        <div id="image-preview" class="mt-3 hidden">
                            <img id="preview-img" src="" alt="Preview" class="w-full h-48 object-cover rounded-lg border border-slate-200 dark:border-slate-600">
                        </div>
                    </div>

                    <!-- Author and Category Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Author -->
                        <div>
                            <label for="article-author" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Author *</label>
                            <select id="article-author" name="authorId" required
                                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                                <option value="">Select an author...</option>
                            </select>
                        </div>

                        <!-- Category -->
                        <div>
                            <label for="article-category" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Category *</label>
                            <select id="article-category" name="categoryId" required
                                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                                <option value="">Select a category...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Status and Scheduling -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Status -->
                        <div>
                            <label for="article-status" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Status</label>
                            <select id="article-status" name="status" onchange="adminDashboard.handleStatusChange(this.value)"
                                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                                <option value="DRAFT">Draft</option>
                                <option value="PENDING">Pending Review</option>
                                <option value="PUBLISHED">Published</option>
                                <option value="SCHEDULED">Scheduled</option>
                            </select>
                        </div>

                        <!-- Publish Date/Time -->
                        <div id="publish-date-container" class="hidden">
                            <label for="article-publish-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                <span id="publish-date-label">Publish Date & Time</span>
                            </label>
                            <input type="datetime-local" id="article-publish-date" name="publishedAt"
                                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1" id="publish-date-help">
                                Leave empty to publish immediately
                            </p>
                        </div>
                    </div>

                    <!-- SEO Settings -->
                    <div class="border-t border-slate-200 dark:border-slate-700 pt-6">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">SEO & Social Media</h3>

                        <!-- Meta Description -->
                        <div class="mb-4">
                            <label for="article-meta-description" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                Meta Description
                            </label>
                            <textarea id="article-meta-description" name="metaDescription" rows="2" maxlength="160"
                                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                                placeholder="Brief description for search engines (160 characters max)"
                                oninput="adminDashboard.updateMetaCharCount()"></textarea>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-xs text-slate-500 dark:text-slate-400">Appears in search engine results</p>
                                <span id="meta-char-count" class="text-xs text-slate-500 dark:text-slate-400">0/160</span>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="mb-4">
                            <label for="article-tags" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                Tags
                            </label>
                            <input type="text" id="article-tags" name="tags"
                                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                                placeholder="Enter tags separated by commas (e.g., community, culture, news)">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Separate multiple tags with commas</p>
                        </div>

                        <!-- Featured Article Toggle -->
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="article-featured" name="featured"
                                class="w-4 h-4 text-yellow-500 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded focus:ring-yellow-500">
                            <label for="article-featured" class="text-sm font-medium text-slate-700 dark:text-slate-300">
                                Feature this article on homepage
                            </label>
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div>
                        <label for="article-content" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Content *</label>
                        <div class="border border-slate-300 dark:border-slate-600 rounded-lg overflow-hidden">
                            <!-- Enhanced Editor Toolbar -->
                            <div class="bg-slate-50 dark:bg-slate-700 border-b border-slate-300 dark:border-slate-600 p-3">
                                <!-- First Row: Basic Formatting -->
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <!-- Text Formatting -->
                                    <div class="flex gap-1">
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('bold')" title="Bold (Ctrl+B)">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('italic')" title="Italic (Ctrl+I)">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4l4 16m-4-8h8"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('underline')" title="Underline (Ctrl+U)">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v8a4 4 0 008 0V4M4 20h16"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('strikeThrough')" title="Strikethrough">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 12h12M6 8h12M6 16h12"></path>
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="w-px bg-slate-300 dark:bg-slate-600"></div>

                                    <!-- Headings -->
                                    <div class="flex gap-1">
                                        <select class="editor-select text-sm border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-800" onchange="adminDashboard.formatHeading(this.value)" title="Heading Style">
                                            <option value="">Normal</option>
                                            <option value="h1">Heading 1</option>
                                            <option value="h2">Heading 2</option>
                                            <option value="h3">Heading 3</option>
                                            <option value="h4">Heading 4</option>
                                        </select>
                                    </div>

                                    <div class="w-px bg-slate-300 dark:bg-slate-600"></div>

                                    <!-- Lists -->
                                    <div class="flex gap-1">
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('insertUnorderedList')" title="Bullet List">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('insertOrderedList')" title="Numbered List">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('indent')" title="Increase Indent">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m0 0l4-4m-4 4l4 4M4 18h16"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('outdent')" title="Decrease Indent">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m0 0l-4-4m4 4l-4 4M4 18h16"></path>
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="w-px bg-slate-300 dark:bg-slate-600"></div>

                                    <!-- Alignment -->
                                    <div class="flex gap-1">
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('justifyLeft')" title="Align Left">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h10M4 12h16M4 18h10"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('justifyCenter')" title="Align Center">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 6h10M4 12h16M7 18h10"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('justifyRight')" title="Align Right">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h10M4 12h16M10 18h10"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('justifyFull')" title="Justify">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Second Row: Advanced Features -->
                                <div class="flex flex-wrap gap-2">
                                    <!-- Links and Media -->
                                    <div class="flex gap-1">
                                        <button type="button" class="editor-btn" onclick="adminDashboard.insertLink()" title="Insert Link">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.insertImage()" title="Insert Image">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.insertTable()" title="Insert Table">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0V6a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.insertQuote()" title="Insert Quote">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="w-px bg-slate-300 dark:bg-slate-600"></div>

                                    <!-- Utilities -->
                                    <div class="flex gap-1">
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('removeFormat')" title="Clear Formatting">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('undo')" title="Undo (Ctrl+Z)">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.formatText('redo')" title="Redo (Ctrl+Y)">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"></path>
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="w-px bg-slate-300 dark:bg-slate-600"></div>

                                    <!-- View Options -->
                                    <div class="flex gap-1">
                                        <button type="button" class="editor-btn" onclick="adminDashboard.toggleEditorMode()" title="Toggle HTML View" id="html-view-btn">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                            </svg>
                                        </button>
                                        <button type="button" class="editor-btn" onclick="adminDashboard.toggleFullscreen()" title="Fullscreen Editor" id="fullscreen-btn">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Content Area -->
                            <div id="article-content" contenteditable="true"
                                class="editor-content min-h-[400px] p-4 focus:outline-none bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 leading-relaxed"
                                placeholder="Write your article content here..."
                                style="line-height: 1.6; font-size: 16px;">
                            </div>

                            <!-- HTML Source View (Hidden by default) -->
                            <textarea id="article-content-html"
                                class="editor-content html-mode min-h-[400px] p-4 focus:outline-none bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-mono text-sm hidden w-full border-none resize-none"
                                placeholder="HTML source code will appear here..."></textarea>

                            <!-- Word Count and Status -->
                            <div class="px-4 py-2 bg-slate-50 dark:bg-slate-700 border-t border-slate-200 dark:border-slate-600 flex justify-between items-center text-sm text-slate-600 dark:text-slate-400">
                                <div class="flex items-center space-x-4">
                                    <span id="word-count">0 words</span>
                                    <span id="char-count">0 characters</span>
                                    <span id="reading-time">~0 min read</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="editor-status" class="text-green-600 dark:text-green-400"></span>
                                    <div id="auto-save-indicator" class="hidden">
                                        <svg class="w-4 h-4 animate-spin text-blue-500" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700">
                <div class="flex items-center space-x-4">
                    <span id="save-status" class="text-sm text-slate-600 dark:text-slate-400"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="adminDashboard.closeArticleEditor()"
                        class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="adminDashboard.saveArticle()"
                        class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg btn-primary flex items-center space-x-2">
                        <span id="save-btn-text">Save Article</span>
                        <div id="save-spinner" class="hidden spinner"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Library Modal -->
    <div id="media-library-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Media Library</h2>
                <div class="flex items-center space-x-3">
                    <button onclick="adminDashboard.uploadMedia()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg btn-primary flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <span>Upload</span>
                    </button>
                    <button onclick="adminDashboard.closeMediaLibrary()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-hidden flex">
                <!-- Sidebar -->
                <div class="w-64 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-700 p-4">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Filter by Type</label>
                            <select id="media-type-filter" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                                <option value="">All Media</option>
                                <option value="image">Images</option>
                                <option value="video">Videos</option>
                                <option value="document">Documents</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Search</label>
                            <input type="text" id="media-search" placeholder="Search media..."
                                class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Sort by</label>
                            <select id="media-sort" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="name">Name A-Z</option>
                                <option value="size">File Size</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Media Grid -->
                <div class="flex-1 p-6 overflow-y-auto">
                    <div id="media-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <!-- Media items will be loaded here -->
                    </div>

                    <!-- Empty State -->
                    <div id="media-empty-state" class="hidden text-center py-12">
                        <svg class="w-16 h-16 text-slate-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-slate-800 dark:text-slate-200 mb-2">No media files</h3>
                        <p class="text-slate-600 dark:text-slate-400 mb-4">Upload your first image or document to get started.</p>
                        <button onclick="adminDashboard.uploadMedia()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg btn-primary">
                            Upload Media
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700">
                <div class="text-sm text-slate-600 dark:text-slate-400">
                    <span id="media-count">0 items</span> • <span id="media-storage">0 MB used</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="adminDashboard.closeMediaLibrary()"
                        class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                        Close
                    </button>
                    <button type="button" onclick="adminDashboard.selectMedia()" id="select-media-btn"
                        class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Select Media
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Editor Modal -->
    <div id="category-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 id="category-editor-modal-title" class="text-2xl font-bold text-slate-800 dark:text-slate-200">Add Category</h2>
                <button onclick="adminDashboard.closeCategoryEditor()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto">
                <form id="category-editor-form" class="p-6 space-y-6">
                    <!-- Name -->
                    <div>
                        <label for="category-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Category Name *</label>
                        <input type="text" id="category-name" name="name" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-lg font-semibold"
                            placeholder="e.g., News, Sports, Opinion"
                            oninput="adminDashboard.updateSlugFromName(this.value)">
                    </div>

                    <!-- Slug -->
                    <div>
                        <label for="category-slug" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">URL Slug</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-slate-500 dark:text-slate-400">/</span>
                            <input type="text" id="category-slug" name="slug"
                                class="w-full pl-8 pr-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                                placeholder="auto-generated from name">
                        </div>
                        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Leave empty to auto-generate from name</p>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="category-description" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Description</label>
                        <textarea id="category-description" name="description" rows="3"
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="Brief description of this category..."></textarea>
                    </div>

                    <!-- Color -->
                    <div>
                        <label for="category-color" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Category Color</label>
                        <div class="flex items-center space-x-4">
                            <input type="color" id="category-color" name="color" value="#6B7280"
                                class="w-16 h-12 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer"
                                onchange="adminDashboard.updateColorText(this.value)">
                            <input type="text" id="category-color-text" value="#6B7280"
                                class="flex-1 px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-mono"
                                placeholder="#6B7280"
                                onchange="adminDashboard.updateColorPicker(this.value)">
                        </div>
                        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Used for category badges and theming</p>
                    </div>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700">
                <div class="flex items-center space-x-4">
                    <span id="category-save-status" class="text-sm text-slate-600 dark:text-slate-400"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="adminDashboard.closeCategoryEditor()"
                        class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="adminDashboard.saveCategoryForm()"
                        class="px-6 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg btn-primary flex items-center space-x-2">
                        <span id="category-save-btn-text">Save Category</span>
                        <div id="category-save-spinner" class="hidden spinner"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Container -->
    <div id="admin-app" class="min-h-screen">
        <!-- Login Screen -->
        <div id="login-screen" class="login-container flex items-center justify-center">
            <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200 mb-2">
                        <span class="text-yellow-500">ONWARD</span>
                        <span class="text-slate-700 dark:text-slate-300">DOMINICANS</span>
                    </h1>
                    <p class="text-slate-600 dark:text-slate-400">Admin Dashboard</p>
                </div>
                
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
                        <input type="email" id="email" name="email" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="admin@onwarddominicans.com">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Password</label>
                        <input type="password" id="password" name="password" required
                            class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
                            placeholder="••••••••">
                    </div>
                    
                    <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg btn-primary focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
                        <span class="login-text">Sign In</span>
                        <div class="spinner hidden inline-block ml-2"></div>
                    </button>
                </form>
                
                <div id="login-error" class="mt-4 p-3 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 rounded-lg hidden">
                    <p class="text-sm">Invalid credentials. Please try again.</p>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard-screen" class="hidden">
            <!-- Top Navigation -->
            <nav class="bg-white dark:bg-slate-800 shadow-lg border-b border-slate-200 dark:border-slate-700">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center">
                            <h1 class="text-xl font-bold">
                                <span class="text-yellow-500">ONWARD</span>
                                <span class="text-slate-700 dark:text-slate-300">DOMINICANS</span>
                                <span class="text-sm font-normal text-slate-500 dark:text-slate-400 ml-2">Admin</span>
                            </h1>
                        </div>

                        <div class="flex items-center space-x-4">
                            <button id="theme-toggle" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                                <svg class="w-5 h-5 text-slate-600 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                </svg>
                            </button>

                            <div class="relative">
                                <button id="user-menu-button" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                                    <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold text-sm" id="user-avatar">A</span>
                                    </div>
                                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300" id="user-name">Admin User</span>
                                    <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                
                                <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 z-50">
                                    <div class="py-1">
                                        <a href="#" class="block px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">Profile Settings</a>
                                        <hr class="border-slate-200 dark:border-slate-700">
                                        <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700">Sign Out</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div class="flex">
                <!-- Sidebar -->
                <aside class="w-64 bg-slate-800 dark:bg-slate-900 min-h-screen">
                    <nav class="mt-8">
                        <div class="px-4 space-y-2">
                            <a href="#" class="sidebar-item active flex items-center px-4 py-3 text-white rounded-lg" data-section="dashboard">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                </svg>
                                Dashboard
                            </a>

                            <a href="#" class="sidebar-item flex items-center px-4 py-3 text-slate-300 hover:text-white rounded-lg" data-section="articles">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Articles
                                <span id="articles-count" class="ml-auto bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                            </a>

                            <a href="#" class="sidebar-item flex items-center px-4 py-3 text-slate-300 hover:text-white rounded-lg" data-section="gallery">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Gallery
                                <span id="gallery-count" class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                            </a>

                            <a href="#" class="sidebar-item flex items-center px-4 py-3 text-slate-300 hover:text-white rounded-lg" data-section="authors">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Authors
                            </a>

                            <a href="#" class="sidebar-item flex items-center px-4 py-3 text-slate-300 hover:text-white rounded-lg" data-section="categories">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                Categories
                            </a>

                            <a href="#" class="sidebar-item flex items-center px-4 py-3 text-slate-300 hover:text-white rounded-lg" data-section="analytics">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Analytics
                            </a>

                            <a href="#" class="sidebar-item flex items-center px-4 py-3 text-slate-300 hover:text-white rounded-lg" data-section="settings">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Settings
                            </a>
                        </div>
                    </nav>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 p-8" id="main-content">
                    <!-- Content will be dynamically loaded here -->
                </main>
            </div>
        </div>
    </div>

    <script>
        // Comprehensive Admin Dashboard with Full Backend Integration
        class AdminDashboard {
            constructor() {
                this.currentUser = null;
                this.currentSection = 'dashboard';

                // Smart API URL detection for admin panel
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const isLocalNetwork = window.location.hostname.startsWith('10.0.2.') || window.location.hostname.startsWith('192.168.');
                const isVercelDomain = window.location.hostname.includes('vercel.app') || window.location.hostname.includes('odmailsu');

                if (isLocalhost || isLocalNetwork) {
                    // Use local backend for development
                    this.apiBase = `http://${window.location.hostname === '10.0.2.15' ? '10.0.2.15' : 'localhost'}:3001/api`;
                } else if (isVercelDomain || window.location.protocol === 'https:') {
                    // Use production backend for Vercel deployment or any HTTPS site
                    this.apiBase = 'https://onward-dominicans-backend-v2.onrender.com/api';
                } else {
                    // Fallback to production backend
                    this.apiBase = 'https://onward-dominicans-backend-v2.onrender.com/api';
                }

                // Supabase configuration for fallback
                this.supabaseUrl = 'https://zrsfmghkjhxkjjzkigck.supabase.co';
                this.supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyc2ZtZ2hramh4a2pqemtpZ2NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NjQwMDcsImV4cCI6MjA2NTE0MDAwN30.HGkX4r3NCfsyzk0pMsLS0N40K904zWA2CZyZ3Pr-bxM';

                console.log('🔧 Admin API Base URL:', this.apiBase);
                console.log('🔧 Supabase Fallback URL:', this.supabaseUrl);
                console.log('🌐 Current hostname:', window.location.hostname);
                console.log('🔒 Protocol:', window.location.protocol);
                this.token = localStorage.getItem('admin-token');
                this.articles = [];
                this.authors = [];
                this.categories = [];
                this.galleryItems = [];
                this.galleryCategories = [];
                this.stats = {};
                this.featuredArticle = null;
                this.currentEditingArticle = null;
                this.currentEditingAuthor = null;
                this.currentEditingCategory = null;
                this.currentEditingGalleryItem = null;
                this.currentEditingGalleryCategory = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupTheme();
                this.checkAuthStatus();
                this.setupArticleEditor();
                this.setupAuthorEditor();
                this.setupGalleryEditors();
            }

            setupEventListeners() {
                // Login form
                document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));

                // Logout
                document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());

                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

                // User menu
                const userMenuButton = document.getElementById('user-menu-button');
                const userMenu = document.getElementById('user-menu');
                userMenuButton.addEventListener('click', () => userMenu.classList.toggle('hidden'));

                // Close menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userMenuButton.contains(e.target) && !userMenu.contains(e.target)) {
                        userMenu.classList.add('hidden');
                    }
                });

                // Sidebar navigation
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.getAttribute('data-section');
                        this.showSection(section);
                    });
                });
            }

            setupTheme() {
                const savedTheme = localStorage.getItem('admin-theme') || 'light';
                this.setTheme(savedTheme);
            }

            setTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('admin-theme', theme);
            }

            toggleTheme() {
                const isDark = document.documentElement.classList.contains('dark');
                this.setTheme(isDark ? 'light' : 'dark');

                // Refresh analytics charts if we're on the analytics page
                if (this.currentSection === 'analytics' && window.analyticsCharts) {
                    setTimeout(() => {
                        // Re-initialize charts with new theme colors
                        const analytics = this.lastAnalyticsData;
                        if (analytics) {
                            this.initializeAnalyticsCharts(analytics);
                        }
                    }, 100);
                }
            }

            async checkAuthStatus() {
                console.log('✅ Skipping authentication - direct admin access');
                // Skip authentication and go directly to dashboard
                this.currentUser = {
                    id: 'admin',
                    email: 'admin@onwarddominicans.com',
                    role: 'ADMIN',
                    firstName: 'Admin',
                    lastName: 'User'
                };
                this.showDashboard();
            }

            async handleLogin(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const email = formData.get('email');
                const password = formData.get('password');

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const loginText = submitBtn.querySelector('.login-text');
                const spinner = submitBtn.querySelector('.spinner');

                loginText.textContent = 'Signing In...';
                spinner.classList.remove('hidden');
                submitBtn.disabled = true;

                try {
                    const response = await this.makeAPICall('/auth/login', 'POST', { email, password });

                    if (response.success) {
                        this.token = response.data.token;
                        this.currentUser = response.data.user;
                        localStorage.setItem('admin-token', this.token);
                        localStorage.setItem('admin-user', JSON.stringify(this.currentUser));
                        this.showToast('Login successful!', 'success');
                        this.showDashboard();
                    } else {
                        this.showLoginError(response.message || 'Invalid credentials');
                    }
                } catch (error) {
                    this.showLoginError('Connection error. Please try again.');
                } finally {
                    loginText.textContent = 'Sign In';
                    spinner.classList.add('hidden');
                    submitBtn.disabled = false;
                }
            }

            handleLogout() {
                this.currentUser = null;
                this.token = null;
                localStorage.removeItem('admin-token');
                localStorage.removeItem('admin-user');
                this.showToast('Logged out successfully', 'info');
                this.showLogin();
            }

            showLogin() {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard-screen').classList.add('hidden');
            }

            showDashboard() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                this.updateUserInfo();
                this.showSection('dashboard');
            }

            updateUserInfo() {
                if (this.currentUser) {
                    const userName = document.getElementById('user-name');
                    const userAvatar = document.getElementById('user-avatar');
                    userName.textContent = this.currentUser.firstName ?
                        `${this.currentUser.firstName} ${this.currentUser.lastName || ''}`.trim() :
                        this.currentUser.username;
                    userAvatar.textContent = (this.currentUser.firstName || this.currentUser.username).charAt(0).toUpperCase();
                }
            }

            showLoginError(message = 'Invalid credentials. Please try again.') {
                const errorElement = document.getElementById('login-error');
                errorElement.querySelector('p').textContent = message;
                errorElement.classList.remove('hidden');
            }

            hideLoginError() {
                document.getElementById('login-error').classList.add('hidden');
            }

            async makeAPICall(endpoint, method = 'GET', data = null) {
                console.log(`🌐 API Call: ${method} ${this.apiBase}${endpoint}`);

                // Use Supabase directly for all operations since backend is down
                if (endpoint.startsWith('/articles')) {
                    return this.handleArticleOperation(endpoint, method, data);
                }
                if (endpoint.startsWith('/authors')) {
                    return this.handleAuthorOperation(endpoint, method, data);
                }
                if (endpoint.startsWith('/categories')) {
                    return this.handleCategoryOperation(endpoint, method, data);
                }
                if (endpoint.startsWith('/gallery')) {
                    return this.handleGalleryOperation(endpoint, method, data);
                }

                // For non-article operations, try backend first, then fallback
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                    console.log('📤 Request data:', data);
                }

                try {
                    const response = await fetch(`${this.apiBase}${endpoint}`, options);
                    const result = await response.json();

                    console.log(`📥 API Response (${response.status}):`, result);

                    if (!response.ok) {
                        const errorMessage = result.error?.message || result.message || 'API call failed';
                        console.error('❌ API Error Details:', result.error);
                        throw new Error(errorMessage);
                    }

                    return result;
                } catch (error) {
                    console.error('❌ API Call failed:', error);
                    throw error;
                }
            }

            async handleArticleOperation(endpoint, method, data) {
                console.log(`🔄 Using Supabase for article operation: ${method} ${endpoint}`);

                try {
                    if (method === 'GET') {
                        if (endpoint === '/articles') {
                            return await this.getArticlesFromSupabase();
                        } else if (endpoint.match(/^\/articles\/[^\/]+$/)) {
                            const id = endpoint.split('/')[2];
                            return await this.getArticleFromSupabase(id);
                        }
                    } else if (method === 'POST') {
                        if (endpoint === '/articles') {
                            return await this.createArticleInSupabase(data);
                        }
                    } else if (method === 'PUT') {
                        if (endpoint.match(/^\/articles\/[^\/]+$/)) {
                            const id = endpoint.split('/')[2];
                            return await this.updateArticleInSupabase(id, data);
                        }
                    } else if (method === 'DELETE') {
                        if (endpoint.match(/^\/articles\/[^\/]+$/)) {
                            const id = endpoint.split('/')[2];
                            return await this.deleteArticleFromSupabase(id);
                        }
                    }

                    throw new Error(`Unsupported article operation: ${method} ${endpoint}`);
                } catch (error) {
                    console.error('❌ Supabase article operation failed:', error);
                    throw error;
                }
            }

            // Supabase operations for articles
            async getArticlesFromSupabase() {
                try {
                    console.log('🔄 Fetching articles from Supabase...');

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/articles?select=*,author:authors(*),category:categories(*),tags(*)&order=createdAt.desc`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Supabase request failed: ${response.status}`);
                    }

                    const articles = await response.json();
                    console.log(`✅ Loaded ${articles.length} articles from Supabase`);

                    return {
                        success: true,
                        data: articles,
                        meta: {
                            total: articles.length,
                            page: 1,
                            limit: articles.length,
                            totalPages: 1,
                            hasNext: false,
                            hasPrev: false
                        }
                    };
                } catch (error) {
                    console.error('❌ Supabase fallback failed:', error);
                    return {
                        success: false,
                        data: [],
                        error: { message: error.message }
                    };
                }
            }

            async getArticleFromSupabase(id) {
                try {
                    console.log('🔄 Fetching article from Supabase:', id);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/articles?select=*,author:authors(*),category:categories(*),tags(*)&id=eq.${id}`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Supabase request failed: ${response.status}`);
                    }

                    const articles = await response.json();
                    const article = articles.length > 0 ? articles[0] : null;

                    return {
                        success: true,
                        data: article
                    };
                } catch (error) {
                    console.error('❌ Supabase get article failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async createArticleInSupabase(articleData) {
                try {
                    console.log('🔄 Creating article in Supabase:', articleData);

                    // Generate a unique ID for the article
                    const id = 'article-' + Date.now();

                    const supabaseData = {
                        id: id,
                        title: articleData.title,
                        slug: articleData.slug || articleData.title.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
                        summary: articleData.summary,
                        content: articleData.content,
                        imageUrl: articleData.imageUrl,
                        status: articleData.status || 'DRAFT',
                        publishedAt: articleData.status === 'PUBLISHED' ? new Date().toISOString() : null,
                        authorId: articleData.authorId || 'cmbsufpwv00029dur4q46etar',
                        categoryId: articleData.categoryId || 'cmbsufqb100059durwnc7eri6',
                        createdBy: 'cmbsufok100009durfa1z503t'
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/articles`, {
                        method: 'POST',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase create failed: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    console.log('✅ Article created in Supabase:', result);

                    return {
                        success: true,
                        data: result[0]
                    };
                } catch (error) {
                    console.error('❌ Supabase create article failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async updateArticleInSupabase(id, articleData) {
                try {
                    console.log('🔄 Updating article in Supabase:', id, articleData);

                    const supabaseData = {
                        title: articleData.title,
                        slug: articleData.slug || articleData.title.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
                        summary: articleData.summary,
                        content: articleData.content,
                        imageUrl: articleData.imageUrl,
                        status: articleData.status,
                        publishedAt: articleData.status === 'PUBLISHED' ? new Date().toISOString() : null,
                        authorId: articleData.authorId,
                        categoryId: articleData.categoryId,
                        updatedAt: new Date().toISOString()
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/articles?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase update failed: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    console.log('✅ Article updated in Supabase:', result);

                    return {
                        success: true,
                        data: result[0]
                    };
                } catch (error) {
                    console.error('❌ Supabase update article failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async deleteArticleFromSupabase(id) {
                try {
                    console.log('🔄 Deleting article from Supabase:', id);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/articles?id=eq.${id}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase delete failed: ${response.status} - ${error}`);
                    }

                    console.log('✅ Article deleted from Supabase');

                    return {
                        success: true,
                        data: { message: 'Article deleted successfully' }
                    };
                } catch (error) {
                    console.error('❌ Supabase delete article failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async getAuthorsFromSupabase() {
                try {
                    console.log('🔄 Fetching authors from Supabase...');

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/authors?order=createdAt.desc`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Supabase request failed: ${response.status}`);
                    }

                    const authors = await response.json();
                    console.log(`✅ Loaded ${authors.length} authors from Supabase`);

                    // Get article counts for each author
                    console.log('🔄 Fetching article counts for authors...');
                    const authorsWithCounts = await Promise.all(authors.map(async (author) => {
                        try {
                            const articlesResponse = await fetch(
                                `${this.supabaseUrl}/rest/v1/articles?authorId=eq.${author.id}&select=id&status=eq.PUBLISHED`,
                                {
                                    headers: {
                                        'apikey': this.supabaseAnonKey,
                                        'Authorization': `Bearer ${this.supabaseAnonKey}`,
                                        'Content-Type': 'application/json'
                                    }
                                }
                            );

                            if (articlesResponse.ok) {
                                const articles = await articlesResponse.json();
                                return {
                                    ...author,
                                    articleCount: articles.length
                                };
                            } else {
                                return {
                                    ...author,
                                    articleCount: 0
                                };
                            }
                        } catch (error) {
                            console.warn(`Failed to get article count for author ${author.name}:`, error);
                            return {
                                ...author,
                                articleCount: 0
                            };
                        }
                    }));

                    console.log('✅ Added article counts to authors');

                    return {
                        success: true,
                        data: authorsWithCounts,
                        meta: {
                            total: authorsWithCounts.length
                        }
                    };
                } catch (error) {
                    console.error('❌ Supabase authors fetch failed:', error);
                    return {
                        success: false,
                        data: [],
                        error: { message: error.message }
                    };
                }
            }

            async getAuthorFromSupabase(id) {
                try {
                    console.log('🔄 Fetching author from Supabase:', id);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/authors?id=eq.${id}`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Supabase request failed: ${response.status}`);
                    }

                    const authors = await response.json();
                    const author = authors.length > 0 ? authors[0] : null;

                    if (!author) {
                        throw new Error('Author not found');
                    }

                    console.log('✅ Author loaded from Supabase:', author.name);

                    return {
                        success: true,
                        data: author
                    };
                } catch (error) {
                    console.error('❌ Supabase author fetch failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async createAuthorInSupabase(authorData) {
                try {
                    console.log('🔄 Creating author in Supabase:', authorData);

                    // Generate a unique ID for the author
                    const authorId = 'author-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                    const supabaseData = {
                        id: authorId,
                        name: authorData.name,
                        email: authorData.email,
                        bio: authorData.bio || null,
                        avatarUrl: authorData.avatarUrl || null,
                        isActive: authorData.isActive !== false // Default to true
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/authors`, {
                        method: 'POST',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase create failed: ${response.status} - ${error}`);
                    }

                    const createdAuthor = await response.json();
                    console.log('✅ Author created in Supabase:', createdAuthor[0]?.name);

                    return {
                        success: true,
                        data: createdAuthor[0] || supabaseData
                    };
                } catch (error) {
                    console.error('❌ Supabase author create failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async updateAuthorInSupabase(id, authorData) {
                try {
                    console.log('🔄 Updating author in Supabase:', id, authorData);

                    const supabaseData = {
                        name: authorData.name,
                        email: authorData.email,
                        bio: authorData.bio || null,
                        avatarUrl: authorData.avatarUrl || null,
                        isActive: authorData.isActive !== false
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/authors?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase update failed: ${response.status} - ${error}`);
                    }

                    const updatedAuthor = await response.json();
                    console.log('✅ Author updated in Supabase:', updatedAuthor[0]?.name);

                    return {
                        success: true,
                        data: updatedAuthor[0] || { id, ...supabaseData }
                    };
                } catch (error) {
                    console.error('❌ Supabase author update failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async deleteAuthorFromSupabase(id) {
                try {
                    console.log('🔄 Deleting author from Supabase:', id);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/authors?id=eq.${id}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase delete failed: ${response.status} - ${error}`);
                    }

                    console.log('✅ Author deleted from Supabase');

                    return {
                        success: true,
                        data: { message: 'Author deleted successfully' }
                    };
                } catch (error) {
                    console.error('❌ Supabase author delete failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async getCategoriesFromSupabase() {
                try {
                    console.log('🔄 Fetching categories from Supabase...');

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/categories?order=name.asc`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Supabase request failed: ${response.status}`);
                    }

                    const categories = await response.json();
                    console.log(`✅ Loaded ${categories.length} categories from Supabase`);

                    return {
                        success: true,
                        data: categories,
                        meta: {
                            total: categories.length
                        }
                    };
                } catch (error) {
                    console.error('❌ Supabase categories fetch failed:', error);
                    return {
                        success: false,
                        data: [],
                        error: { message: error.message }
                    };
                }
            }

            async handleAuthorOperation(endpoint, method, data) {
                console.log(`🔄 Using Supabase for author operation: ${method} ${endpoint}`);

                try {
                    if (method === 'GET') {
                        if (endpoint === '/authors' || endpoint.includes('/authors?')) {
                            return await this.getAuthorsFromSupabase();
                        }
                        // Handle single author fetch
                        const idMatch = endpoint.match(/\/authors\/([^\/]+)$/);
                        if (idMatch) {
                            return await this.getAuthorFromSupabase(idMatch[1]);
                        }
                    }

                    if (method === 'POST' && endpoint === '/authors') {
                        return await this.createAuthorInSupabase(data);
                    }

                    if (method === 'PUT') {
                        const idMatch = endpoint.match(/\/authors\/([^\/]+)$/);
                        if (idMatch) {
                            return await this.updateAuthorInSupabase(idMatch[1], data);
                        }
                    }

                    if (method === 'DELETE') {
                        const idMatch = endpoint.match(/\/authors\/([^\/]+)$/);
                        if (idMatch) {
                            return await this.deleteAuthorFromSupabase(idMatch[1]);
                        }
                    }

                    // Fallback for unhandled operations
                    return {
                        success: false,
                        error: { message: `Unsupported author operation: ${method} ${endpoint}` }
                    };
                } catch (error) {
                    console.error('❌ Supabase author operation failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async handleCategoryOperation(endpoint, method, data) {
                console.log(`🔄 Using Supabase for category operation: ${method} ${endpoint}`);

                try {
                    if (method === 'GET') {
                        if (endpoint === '/categories' || endpoint.includes('/categories?')) {
                            return await this.getCategoriesFromSupabase();
                        }
                    }

                    // For now, return success for other category operations
                    return {
                        success: true,
                        data: { message: 'Category operation completed' }
                    };
                } catch (error) {
                    console.error('❌ Supabase category operation failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async handleGalleryOperation(endpoint, method, data) {
                console.log(`🔄 Using Supabase for gallery operation: ${method} ${endpoint}`);

                try {
                    if (method === 'GET') {
                        if (endpoint === '/gallery' || endpoint.includes('/gallery?')) {
                            return await this.getGalleryFromSupabase();
                        } else if (endpoint === '/gallery-categories' || endpoint.includes('/gallery-categories?')) {
                            return await this.getGalleryCategoriesFromSupabase();
                        }
                    } else if (method === 'POST') {
                        if (endpoint === '/gallery') {
                            return await this.createGalleryItemInSupabase(data);
                        } else if (endpoint === '/gallery-categories') {
                            return await this.createGalleryCategoryInSupabase(data);
                        }
                    } else if (method === 'PUT') {
                        if (endpoint.match(/^\/gallery\/[^\/]+$/)) {
                            const id = endpoint.split('/')[2];
                            return await this.updateGalleryItemInSupabase(id, data);
                        } else if (endpoint.match(/^\/gallery-categories\/[^\/]+$/)) {
                            const id = endpoint.split('/')[2];
                            return await this.updateGalleryCategoryInSupabase(id, data);
                        }
                    } else if (method === 'DELETE') {
                        if (endpoint.match(/^\/gallery\/[^\/]+$/)) {
                            const id = endpoint.split('/')[2];
                            return await this.deleteGalleryItemFromSupabase(id);
                        } else if (endpoint.match(/^\/gallery-categories\/[^\/]+$/)) {
                            const id = endpoint.split('/')[2];
                            return await this.deleteGalleryCategoryFromSupabase(id);
                        }
                    }

                    // For now, return success for other gallery operations
                    return {
                        success: true,
                        data: { message: 'Gallery operation completed' }
                    };
                } catch (error) {
                    console.error('❌ Supabase gallery operation failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async getGalleryFromSupabase() {
                try {
                    console.log('🔄 Fetching gallery items from Supabase...');

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_items?select=*,category:gallery_categories(*)&order=createdAt.desc`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Supabase request failed: ${response.status}`);
                    }

                    const gallery = await response.json();
                    console.log(`✅ Loaded ${gallery.length} gallery items from Supabase`);

                    return {
                        success: true,
                        data: gallery,
                        meta: {
                            total: gallery.length
                        }
                    };
                } catch (error) {
                    console.error('❌ Supabase gallery fetch failed:', error);
                    return {
                        success: false,
                        data: [],
                        error: { message: error.message }
                    };
                }
            }

            async getGalleryCategoriesFromSupabase() {
                try {
                    console.log('🔄 Fetching gallery categories from Supabase...');

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_categories?order=name.asc`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Supabase request failed: ${response.status}`);
                    }

                    const categories = await response.json();
                    console.log(`✅ Loaded ${categories.length} gallery categories from Supabase`);

                    return {
                        success: true,
                        data: categories,
                        meta: {
                            total: categories.length
                        }
                    };
                } catch (error) {
                    console.error('❌ Supabase gallery categories fetch failed:', error);
                    return {
                        success: false,
                        data: [],
                        error: { message: error.message }
                    };
                }
            }

            async createGalleryItemInSupabase(itemData) {
                try {
                    console.log('🔄 Creating gallery item in Supabase:', itemData);
                    console.log('🔍 DEBUG: Supabase URL:', this.supabaseUrl);
                    console.log('🔍 DEBUG: Supabase Key exists:', !!this.supabaseAnonKey);

                    const id = 'gallery-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    console.log('🔍 DEBUG: Generated ID:', id);

                    const supabaseData = {
                        id: id,
                        title: itemData.title,
                        description: itemData.description || null,
                        imageUrl: itemData.imageUrl,
                        thumbnailUrl: itemData.thumbnailUrl || null,
                        photographer: itemData.photographer || null,
                        dateTaken: itemData.dateTaken || null,
                        location: itemData.location || null,
                        categoryId: itemData.categoryId,
                        stackGroup: itemData.stackGroup || null,
                        stackOrder: itemData.stackOrder || 1,
                        isStackCover: itemData.isStackCover || false,
                        isActive: true,
                        createdBy: 'cmbsufok100009durfa1z503t'
                    };

                    console.log('🔍 DEBUG: Final Supabase data:', JSON.stringify(supabaseData, null, 2));

                    console.log('🔍 DEBUG: Making request to:', `${this.supabaseUrl}/rest/v1/gallery_items`);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_items`, {
                        method: 'POST',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    console.log('🔍 DEBUG: Response status:', response.status);
                    console.log('🔍 DEBUG: Response headers:', Object.fromEntries(response.headers.entries()));

                    if (!response.ok) {
                        const error = await response.text();
                        console.error('🔍 DEBUG: Error response body:', error);
                        throw new Error(`Supabase create failed: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    console.log('✅ Gallery item created in Supabase:', result);
                    console.log('🔍 DEBUG: Created item data:', JSON.stringify(result, null, 2));

                    return {
                        success: true,
                        data: result[0]
                    };
                } catch (error) {
                    console.error('❌ Supabase create gallery item failed:', error);
                    console.error('🔍 DEBUG: Full error object:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async updateGalleryItemInSupabase(id, itemData) {
                try {
                    console.log('🔄 Updating gallery item in Supabase:', id, itemData);

                    const supabaseData = {
                        title: itemData.title,
                        description: itemData.description || null,
                        imageUrl: itemData.imageUrl,
                        thumbnailUrl: itemData.thumbnailUrl || null,
                        photographer: itemData.photographer || null,
                        dateTaken: itemData.dateTaken || null,
                        location: itemData.location || null,
                        categoryId: itemData.categoryId,
                        stackGroup: itemData.stackGroup || null,
                        stackOrder: itemData.stackOrder || 1,
                        isStackCover: itemData.isStackCover || false,
                        isActive: itemData.isActive !== false
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_items?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase update failed: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    console.log('✅ Gallery item updated in Supabase:', result);

                    return {
                        success: true,
                        data: result[0]
                    };
                } catch (error) {
                    console.error('❌ Supabase update gallery item failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async deleteGalleryItemFromSupabase(id) {
                try {
                    console.log('🔄 Deleting gallery item from Supabase:', id);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_items?id=eq.${id}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase delete failed: ${response.status} - ${error}`);
                    }

                    console.log('✅ Gallery item deleted from Supabase');

                    return {
                        success: true,
                        data: { message: 'Gallery item deleted successfully' }
                    };
                } catch (error) {
                    console.error('❌ Supabase delete gallery item failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async createGalleryCategoryInSupabase(categoryData) {
                try {
                    console.log('🔄 Creating gallery category in Supabase:', categoryData);

                    const id = 'gallery-cat-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                    // Generate slug from name
                    const slug = categoryData.name.toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/(^-|-$)/g, '');

                    const supabaseData = {
                        id: id,
                        name: categoryData.name,
                        slug: slug,
                        description: categoryData.description || null,
                        color: categoryData.color || '#3B82F6',
                        isActive: true
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_categories`, {
                        method: 'POST',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase create failed: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    console.log('✅ Gallery category created in Supabase:', result);

                    return {
                        success: true,
                        data: result[0]
                    };
                } catch (error) {
                    console.error('❌ Supabase create gallery category failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async updateGalleryCategoryInSupabase(id, categoryData) {
                try {
                    console.log('🔄 Updating gallery category in Supabase:', id, categoryData);

                    // Generate slug from name if name is being updated
                    const slug = categoryData.name ? categoryData.name.toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/(^-|-$)/g, '') : undefined;

                    const supabaseData = {
                        name: categoryData.name,
                        slug: slug,
                        description: categoryData.description || null,
                        color: categoryData.color || '#3B82F6',
                        isActive: categoryData.isActive !== false
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_categories?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(supabaseData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase update failed: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    console.log('✅ Gallery category updated in Supabase:', result);

                    return {
                        success: true,
                        data: result[0]
                    };
                } catch (error) {
                    console.error('❌ Supabase update gallery category failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async deleteGalleryCategoryFromSupabase(id) {
                try {
                    console.log('🔄 Deleting gallery category from Supabase:', id);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/gallery_categories?id=eq.${id}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase delete failed: ${response.status} - ${error}`);
                    }

                    console.log('✅ Gallery category deleted from Supabase');

                    return {
                        success: true,
                        data: { message: 'Gallery category deleted successfully' }
                    };
                } catch (error) {
                    console.error('❌ Supabase delete gallery category failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            // Helper function to validate URLs (including data URLs)
            isValidUrl(string) {
                try {
                    // Accept data URLs for images
                    if (string.startsWith('data:image/')) {
                        return true;
                    }
                    // Accept regular URLs
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }

            // Debug function to test gallery system
            async debugGallerySystem() {
                console.log('🔍 DEBUG: Starting gallery system debug...');

                // Check Supabase configuration
                console.log('🔍 DEBUG: Supabase URL:', this.supabaseUrl);
                console.log('🔍 DEBUG: Supabase Key exists:', !!this.supabaseAnonKey);
                console.log('🔍 DEBUG: Supabase Key length:', this.supabaseAnonKey?.length);

                // Test Supabase connection
                try {
                    const testResponse = await fetch(`${this.supabaseUrl}/rest/v1/gallery_categories?limit=1`, {
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('🔍 DEBUG: Supabase connection test status:', testResponse.status);

                    if (testResponse.ok) {
                        const testData = await testResponse.json();
                        console.log('🔍 DEBUG: Supabase connection successful, sample data:', testData);
                    } else {
                        const errorText = await testResponse.text();
                        console.error('🔍 DEBUG: Supabase connection failed:', errorText);
                    }
                } catch (error) {
                    console.error('🔍 DEBUG: Supabase connection error:', error);
                }

                // Check form elements
                const form = document.getElementById('gallery-editor-form');
                const categorySelect = document.getElementById('gallery-category');
                const titleInput = document.getElementById('gallery-title');

                console.log('🔍 DEBUG: Form elements check:');
                console.log('  - Form exists:', !!form);
                console.log('  - Category select exists:', !!categorySelect);
                console.log('  - Title input exists:', !!titleInput);
                console.log('  - Category options count:', categorySelect?.options?.length || 0);

                // Check gallery data
                console.log('🔍 DEBUG: Gallery data:');
                console.log('  - Gallery items count:', this.galleryItems?.length || 0);
                console.log('  - Gallery categories count:', this.galleryCategories?.length || 0);

                return {
                    supabaseConfigured: !!(this.supabaseUrl && this.supabaseAnonKey),
                    formElementsPresent: !!(form && categorySelect && titleInput),
                    dataLoaded: !!(this.galleryItems && this.galleryCategories)
                };
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' :
                               type === 'error' ? 'bg-red-500' :
                               type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';

                toast.className = `toast ${bgColor} text-white p-4 rounded-lg shadow-lg show`;
                toast.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                document.getElementById('toast-container').appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hide');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            async showSection(sectionName) {
                // Update sidebar active state
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-section') === sectionName) {
                        item.classList.add('active');
                    }
                });

                this.currentSection = sectionName;
                const mainContent = document.getElementById('main-content');

                // Show loading
                mainContent.innerHTML = '<div class="flex items-center justify-center h-64"><div class="spinner"></div></div>';

                try {
                    switch (sectionName) {
                        case 'dashboard':
                            await this.loadDashboard();
                            break;
                        case 'articles':
                            await this.loadArticles();
                            break;
                        case 'gallery':
                            await this.loadGallery();
                            break;
                        case 'authors':
                            await this.loadAuthors();
                            break;
                        case 'categories':
                            await this.loadCategories();
                            break;
                        case 'analytics':
                            await this.loadAnalytics();
                            break;
                        case 'settings':
                            await this.loadSettings();
                            break;
                        default:
                            mainContent.innerHTML = '<div class="text-center py-12"><h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Section not found</h2></div>';
                    }
                } catch (error) {
                    console.error('Error loading section:', error);
                    mainContent.innerHTML = '<div class="text-center py-12"><h2 class="text-2xl font-bold text-red-600">Error loading content</h2></div>';
                }
            }

            async loadDashboard() {
                try {
                    console.log('🔄 Loading dashboard data from Supabase...');

                    // Load all data from Supabase
                    const [articlesResponse, authorsResponse, categoriesResponse] = await Promise.all([
                        this.getArticlesFromSupabase(),
                        this.getAuthorsFromSupabase(),
                        this.getCategoriesFromSupabase()
                    ]);

                    console.log('📊 Articles response:', articlesResponse);
                    console.log('👥 Authors response:', authorsResponse);
                    console.log('🏷️ Categories response:', categoriesResponse);

                    this.articles = articlesResponse.data || [];
                    this.authors = authorsResponse.data || [];
                    this.categories = categoriesResponse.data || [];

                    // Get the featured article (or most recent published if none is featured)
                    this.featuredArticle = this.articles.find(a => a.isFeatured === true) ||
                                          this.articles.find(a => a.status === 'PUBLISHED') || null;

                    console.log(`✅ Loaded ${this.articles.length} articles, ${this.authors.length} authors, and ${this.categories.length} categories from Supabase`);
                    console.log(`⭐ Featured article:`, this.featuredArticle?.title || 'None');

                    // Update article count in sidebar
                    document.getElementById('articles-count').textContent = articlesResponse.meta?.total || 0;

                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = `
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200">Dashboard</h2>
    <!-- SSG Generation Button -->
    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-green-800 dark:text-green-200">SEO Static Pages</h3>
                <p class="text-sm text-green-600 dark:text-green-400">Generate static pages for better search engine indexing</p>
            </div>
            <button onclick="generateSSGPages()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg btn-primary flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                <span>Generate Static Pages</span>
            </button>
        </div>
    </div>
                            <p class="text-slate-600 dark:text-slate-400 mt-2">Welcome back! Here's what's happening with your news site.</p>
                            <div class="mt-2 text-sm text-green-600 dark:text-green-400">
                                ✅ Data loaded from backend API (${this.articles.length} articles, ${this.authors.length} authors, ${this.categories.length} categories)
                            </div>
                        </div>

                        <!-- Featured Article Management Section -->
                        <div class="mb-8">
                            <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 flex items-center">
                                        <svg class="w-6 h-6 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                        Featured Article Management
                                    </h3>
                                    <button onclick="adminDashboard.openFeaturedArticleSelector()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg btn-primary flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                        </svg>
                                        <span>Change Featured</span>
                                    </button>
                                </div>

                                ${this.featuredArticle ? `
                                    <div class="flex flex-col md:flex-row gap-4">
                                        <div class="md:w-1/3">
                                            <img src="${this.featuredArticle.imageUrl || 'https://images.unsplash.com/photo-1495020689067-958852a7765e?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}"
                                                 alt="${this.featuredArticle.title}"
                                                 class="w-full h-32 object-cover rounded-lg">
                                        </div>
                                        <div class="md:w-2/3">
                                            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">${this.featuredArticle.title}</h4>
                                            <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">
                                                By ${this.featuredArticle.author?.name || 'Unknown Author'} •
                                                ${new Date(this.featuredArticle.publishedAt || this.featuredArticle.createdAt).toLocaleDateString()}
                                            </p>
                                            <p class="text-sm text-slate-700 dark:text-slate-300 line-clamp-2">${this.featuredArticle.summary || 'No summary available'}</p>
                                            <div class="mt-3 flex space-x-2">
                                                <button onclick="adminDashboard.editArticle('${this.featuredArticle.id}')" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">Edit Article</button>
                                                <button onclick="adminDashboard.unsetFeaturedArticle('${this.featuredArticle.id}')" class="text-orange-600 hover:text-orange-800 text-sm font-medium">Remove Featured</button>
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-center py-8">
                                        <svg class="w-16 h-16 text-slate-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                        </svg>
                                        <h4 class="text-lg font-medium text-slate-600 dark:text-slate-400 mb-2">No Featured Article</h4>
                                        <p class="text-slate-500 dark:text-slate-500 mb-4">Select an article to feature on your homepage</p>
                                        <button onclick="adminDashboard.openFeaturedArticleSelector()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg btn-primary">
                                            Select Featured Article
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="stat-card text-white p-6 rounded-xl admin-card">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/80 text-sm">Total Articles</p>
                                        <p class="text-3xl font-bold">${articlesResponse.meta?.total || 0}</p>
                                        <p class="text-white/80 text-sm mt-1">All time</p>
                                    </div>
                                    <div class="bg-white/20 p-3 rounded-lg">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card green text-white p-6 rounded-xl admin-card">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/80 text-sm">Published</p>
                                        <p class="text-3xl font-bold">${this.articles.filter(a => a.status === 'PUBLISHED').length}</p>
                                        <p class="text-white/80 text-sm mt-1">Live articles</p>
                                    </div>
                                    <div class="bg-white/20 p-3 rounded-lg">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card orange text-white p-6 rounded-xl admin-card">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/80 text-sm">Authors</p>
                                        <p class="text-3xl font-bold">${authorsResponse.meta?.total || 0}</p>
                                        <p class="text-white/80 text-sm mt-1">Active writers</p>
                                    </div>
                                    <div class="bg-white/20 p-3 rounded-lg">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card purple text-slate-800 p-6 rounded-xl admin-card">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-slate-600 text-sm">Drafts</p>
                                        <p class="text-3xl font-bold">${this.articles.filter(a => a.status === 'DRAFT').length}</p>
                                        <p class="text-slate-600 text-sm mt-1">Pending work</p>
                                    </div>
                                    <div class="bg-slate-800/10 p-3 rounded-lg">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 admin-card">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200">Recent Articles</h3>
                                    <button onclick="adminDashboard.showSection('articles')" class="text-yellow-600 hover:text-yellow-700 text-sm font-medium">View All</button>
                                </div>
                                <div class="space-y-4">
                                    ${this.articles.slice(0, 3).map(article => `
                                        <div class="flex items-center space-x-4 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                                            <img src="${article.imageUrl || 'https://images.unsplash.com/photo-1495020689067-958852a7765e?ixlib=rb-4.0.3&auto=format&fit=crop&w=60&q=60'}" alt="Article" class="w-12 h-12 rounded-lg object-cover">
                                            <div class="flex-1">
                                                <h4 class="font-medium text-slate-800 dark:text-slate-200">${article.title}</h4>
                                                <p class="text-sm text-slate-600 dark:text-slate-400">${new Date(article.createdAt).toLocaleDateString()}</p>
                                            </div>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${this.getStatusClass(article.status)}">${article.status}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 admin-card">
                                <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200 mb-6">Quick Actions</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="adminDashboard.showSection('articles')" class="flex flex-col items-center p-4 bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg transition-colors btn-primary">
                                        <svg class="w-8 h-8 text-yellow-600 dark:text-yellow-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">New Article</span>
                                    </button>
                                    <button onclick="adminDashboard.showSection('authors')" class="flex flex-col items-center p-4 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors btn-primary">
                                        <svg class="w-8 h-8 text-blue-600 dark:text-blue-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Manage Authors</span>
                                    </button>
                                    <button onclick="adminDashboard.showSection('analytics')" class="flex flex-col items-center p-4 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors btn-primary">
                                        <svg class="w-8 h-8 text-green-600 dark:text-green-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">View Analytics</span>
                                    </button>
                                    <button onclick="adminDashboard.showSection('settings')" class="flex flex-col items-center p-4 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded-lg transition-colors btn-primary">
                                        <svg class="w-8 h-8 text-purple-600 dark:text-purple-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Settings</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    this.showToast('Error loading dashboard data', 'error');
                }
            }

            getStatusClass(status) {
                switch (status) {
                    case 'PUBLISHED':
                        return 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                    case 'DRAFT':
                        return 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
                    case 'PENDING':
                        return 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200';
                    default:
                        return 'bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200';
                }
            }

            async loadArticles() {
                try {
                    console.log('🔄 Loading articles from Supabase...');
                    // Admin should see ALL articles (including drafts), not just published ones
                    const response = await this.getArticlesFromSupabase();
                    console.log('📊 Articles Supabase response:', response);

                    this.articles = response.data || [];
                    console.log(`✅ Loaded ${this.articles.length} articles from Supabase (including drafts)`);

                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = `
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200">Articles</h2>
                                <p class="text-slate-600 dark:text-slate-400 mt-2">Manage your news articles and content.</p>
                            </div>
                            <button onclick="adminDashboard.createArticle()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg btn-primary flex items-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <span>New Article</span>
                            </button>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                            <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <input type="text" id="article-search" placeholder="Search articles..." class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                                        <select id="status-filter" class="px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                                            <option value="">All Status</option>
                                            <option value="PUBLISHED">Published</option>
                                            <option value="DRAFT">Draft</option>
                                            <option value="PENDING">Pending</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="admin-table w-full">
                                    <thead class="bg-slate-50 dark:bg-slate-700">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Article</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Author</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Featured</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700" id="articles-table-body">
                                        ${this.articles.map(article => `
                                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 ${article.isFeatured ? 'bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400' : ''}">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <img class="h-10 w-10 rounded-lg object-cover" src="${article.imageUrl || 'https://images.unsplash.com/photo-1495020689067-958852a7765e?ixlib=rb-4.0.3&auto=format&fit=crop&w=60&q=60'}" alt="">
                                                        <div class="ml-4">
                                                            <div class="text-sm font-medium text-slate-900 dark:text-slate-100 flex items-center">
                                                                ${article.title}
                                                                ${article.isFeatured ? '<svg class="w-4 h-4 text-yellow-500 ml-2" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>' : ''}
                                                            </div>
                                                            <div class="text-sm text-slate-500 dark:text-slate-400">${article.summary.substring(0, 60)}...</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${article.author?.name || 'Unknown'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${this.getStatusClass(article.status)}">${article.status}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    ${article.isFeatured ?
                                                        '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">⭐ Featured</span>' :
                                                        '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300">Regular</span>'
                                                    }
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${new Date(article.createdAt).toLocaleDateString()}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <div class="flex space-x-2">
                                                        <button onclick="adminDashboard.editArticle('${article.id}')" class="text-yellow-600 hover:text-yellow-900">Edit</button>
                                                        ${article.status === 'PUBLISHED' ?
                                                            (article.isFeatured ?
                                                                `<button onclick="adminDashboard.unsetFeaturedArticle('${article.id}')" class="text-orange-600 hover:text-orange-900 font-medium">★ Unfeature</button>` :
                                                                `<button onclick="adminDashboard.setFeaturedArticle('${article.id}')" class="text-green-600 hover:text-green-900 font-medium">☆ Feature</button>`
                                                            ) : ''
                                                        }
                                                        <button onclick="adminDashboard.deleteArticle('${article.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    // Add search and filter functionality
                    this.setupArticleFilters();
                } catch (error) {
                    console.error('Error loading articles:', error);
                    this.showToast('Error loading articles', 'error');
                }
            }

            setupArticleFilters() {
                const searchInput = document.getElementById('article-search');
                const statusFilter = document.getElementById('status-filter');

                const filterArticles = () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusFilter = document.getElementById('status-filter').value;

                    const filteredArticles = this.articles.filter(article => {
                        const matchesSearch = article.title.toLowerCase().includes(searchTerm) ||
                                            article.summary.toLowerCase().includes(searchTerm);
                        const matchesStatus = !statusFilter || article.status === statusFilter;
                        return matchesSearch && matchesStatus;
                    });

                    this.updateArticlesTable(filteredArticles);
                };

                searchInput.addEventListener('input', filterArticles);
                statusFilter.addEventListener('change', filterArticles);
            }

            updateArticlesTable(articles) {
                const tbody = document.getElementById('articles-table-body');
                tbody.innerHTML = articles.map(article => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 ${article.isFeatured ? 'bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img class="h-10 w-10 rounded-lg object-cover" src="${article.imageUrl || 'https://images.unsplash.com/photo-1495020689067-958852a7765e?ixlib=rb-4.0.3&auto=format&fit=crop&w=60&q=60'}" alt="">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-slate-900 dark:text-slate-100 flex items-center">
                                        ${article.title}
                                        ${article.isFeatured ? '<svg class="w-4 h-4 text-yellow-500 ml-2" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>' : ''}
                                    </div>
                                    <div class="text-sm text-slate-500 dark:text-slate-400">${article.summary.substring(0, 60)}...</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-slate-100">${article.author?.name || 'Unknown'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${this.getStatusClass(article.status)}">${article.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${article.isFeatured ?
                                '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">⭐ Featured</span>' :
                                '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300">Regular</span>'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${new Date(article.createdAt).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="adminDashboard.editArticle('${article.id}')" class="text-yellow-600 hover:text-yellow-900">Edit</button>
                                ${article.status === 'PUBLISHED' ?
                                    (article.isFeatured ?
                                        `<button onclick="adminDashboard.unsetFeaturedArticle('${article.id}')" class="text-orange-600 hover:text-orange-900 font-medium">★ Unfeature</button>` :
                                        `<button onclick="adminDashboard.setFeaturedArticle('${article.id}')" class="text-green-600 hover:text-green-900 font-medium">☆ Feature</button>`
                                    ) : ''
                                }
                                <button onclick="adminDashboard.deleteArticle('${article.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            async createArticle() {
                console.log('🆕 Opening article creation modal...');
                this.currentEditingArticle = null;
                this.openArticleEditor();
            }

            async editArticle(articleId) {
                console.log('✏️ Opening article editor for:', articleId);
                try {
                    // Load the article data
                    console.log('🔄 Fetching article data from API...');
                    const response = await this.makeAPICall(`/articles/${articleId}`);
                    console.log('📥 Article API response:', response);

                    if (response.success && response.data) {
                        console.log('✅ Article data loaded successfully:', response.data);
                        this.currentEditingArticle = response.data;
                        await this.openArticleEditor(response.data);
                    } else {
                        console.error('❌ Failed to load article data:', response);
                        this.showToast('Failed to load article data', 'error');
                    }
                } catch (error) {
                    console.error('❌ Error loading article:', error);
                    this.showToast('Error loading article data', 'error');
                }
            }

            async openArticleEditor(article = null) {
                const modal = document.getElementById('article-editor-modal');
                const title = document.getElementById('editor-modal-title');
                const form = document.getElementById('article-editor-form');

                // Set modal title
                title.textContent = article ? 'Edit Article' : 'Create New Article';

                // Show modal first
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                try {
                    // Load authors and categories first
                    console.log('🔄 Loading editor data (authors and categories)...');
                    await this.loadEditorData();
                    console.log('✅ Editor data loaded successfully');

                    // Wait a moment for DOM to be ready
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // Then populate form if editing
                    if (article) {
                        console.log('📝 Populating form for article:', article.title);
                        this.populateArticleForm(article);
                    } else {
                        console.log('🆕 Setting up form for new article');
                        form.reset();
                        const contentField = document.getElementById('article-content');
                        const imagePreview = document.getElementById('image-preview');
                        if (contentField) contentField.innerHTML = '';
                        if (imagePreview) imagePreview.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('❌ Error in openArticleEditor:', error);
                    this.showToast('Error loading editor: ' + error.message, 'error');
                }

                // Focus on title field
                setTimeout(() => {
                    document.getElementById('article-title').focus();
                }, 100);
            }

            closeArticleEditor() {
                const modal = document.getElementById('article-editor-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
                this.currentEditingArticle = null;
            }

            async loadEditorData() {
                try {
                    console.log('🔄 Loading authors and categories for editor...');

                    // Load authors and categories for dropdowns
                    const [authorsResponse, categoriesResponse] = await Promise.all([
                        this.makeAPICall('/authors?limit=100'),
                        this.makeAPICall('/categories?limit=100')
                    ]);

                    console.log('📊 Authors response:', authorsResponse);
                    console.log('📊 Categories response:', categoriesResponse);

                    // Check if form elements exist
                    const authorSelect = document.getElementById('article-author');
                    const categorySelect = document.getElementById('article-category');

                    if (!authorSelect || !categorySelect) {
                        throw new Error('Author or category select elements not found in DOM');
                    }

                    // Populate authors dropdown
                    authorSelect.innerHTML = '<option value="">Select an author...</option>';
                    if (authorsResponse.success && authorsResponse.data) {
                        authorsResponse.data.forEach(author => {
                            const option = document.createElement('option');
                            option.value = author.id;
                            option.textContent = author.name;
                            authorSelect.appendChild(option);
                        });
                        console.log(`✅ Loaded ${authorsResponse.data.length} authors`);
                    } else {
                        console.warn('⚠️ No authors data received');
                    }

                    // Populate categories dropdown
                    categorySelect.innerHTML = '<option value="">Select a category...</option>';
                    if (categoriesResponse.success && categoriesResponse.data) {
                        categoriesResponse.data.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        });
                        console.log(`✅ Loaded ${categoriesResponse.data.length} categories`);
                    } else {
                        console.warn('⚠️ No categories data received');
                    }

                    console.log('✅ Editor data loaded successfully');
                } catch (error) {
                    console.error('❌ Error loading editor data:', error);
                    this.showToast('Error loading editor data: ' + error.message, 'error');
                    throw error; // Re-throw to be caught by openArticleEditor
                }
            }

            populateArticleForm(article) {
                console.log('📝 Populating article form with data:', article);

                try {
                    // Check if all required form elements exist
                    const titleField = document.getElementById('article-title');
                    const summaryField = document.getElementById('article-summary');
                    const imageField = document.getElementById('article-image');
                    const authorField = document.getElementById('article-author');
                    const categoryField = document.getElementById('article-category');
                    const statusField = document.getElementById('article-status');
                    const contentField = document.getElementById('article-content');

                    if (!titleField || !summaryField || !imageField || !authorField || !categoryField || !statusField || !contentField) {
                        throw new Error('One or more form fields are missing from the DOM');
                    }

                    // Populate form fields safely
                    titleField.value = article.title || '';
                    summaryField.value = article.summary || '';
                    imageField.value = article.imageUrl || '';
                    authorField.value = article.authorId || '';
                    categoryField.value = article.categoryId || '';
                    statusField.value = article.status || 'DRAFT';
                    contentField.innerHTML = article.content || '';

                    // Show image preview if URL exists
                    if (article.imageUrl) {
                        this.updateImagePreview(article.imageUrl);
                    }

                    console.log('✅ Article form populated successfully');
                } catch (error) {
                    console.error('❌ Error populating article form:', error);
                    console.error('❌ Article data:', article);
                    console.error('❌ Error details:', error.message);
                    this.showToast('Error populating form data: ' + error.message, 'error');
                }
            }



            formatText(command) {
                try {
                    document.execCommand(command, false, null);
                    const editor = document.getElementById('article-content');
                    if (editor) {
                        editor.focus();
                        this.updateEditorStats();
                    }
                } catch (error) {
                    console.error('Format command failed:', error);
                }
            }

            formatHeading(tag) {
                if (!tag) {
                    this.formatText('formatBlock', 'div');
                    return;
                }

                try {
                    document.execCommand('formatBlock', false, tag);
                    document.getElementById('article-content').focus();
                    this.updateEditorStats();
                } catch (error) {
                    console.error('Heading format failed:', error);
                }
            }

            insertLink() {
                const url = prompt('Enter the URL:');
                if (url) {
                    const text = window.getSelection().toString() || prompt('Enter link text:') || url;
                    try {
                        document.execCommand('insertHTML', false, `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`);
                        document.getElementById('article-content').focus();
                        this.updateEditorStats();
                    } catch (error) {
                        console.error('Insert link failed:', error);
                    }
                }
            }

            insertImage() {
                // Open media library for image selection
                this.openMediaLibrary((selectedMedia) => {
                    const alt = prompt('Enter alt text (optional):') || selectedMedia.name || 'Image';
                    try {
                        const imageHtml = `<img src="${selectedMedia.url}" alt="${alt}" style="max-width: 100%; height: auto; margin: 10px 0;" />`;
                        document.execCommand('insertHTML', false, imageHtml);
                        document.getElementById('article-content').focus();
                        this.updateEditorStats();
                    } catch (error) {
                        console.error('Insert image failed:', error);
                    }
                });
            }

            insertTable() {
                const rows = parseInt(prompt('Number of rows:') || '3');
                const cols = parseInt(prompt('Number of columns:') || '3');

                if (rows > 0 && cols > 0 && rows <= 10 && cols <= 10) {
                    let tableHtml = '<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">';

                    for (let i = 0; i < rows; i++) {
                        tableHtml += '<tr>';
                        for (let j = 0; j < cols; j++) {
                            const tag = i === 0 ? 'th' : 'td';
                            tableHtml += `<${tag} style="border: 1px solid #ccc; padding: 8px; text-align: left;">${i === 0 ? `Header ${j + 1}` : ''}</${tag}>`;
                        }
                        tableHtml += '</tr>';
                    }

                    tableHtml += '</table>';

                    try {
                        document.execCommand('insertHTML', false, tableHtml);
                        document.getElementById('article-content').focus();
                        this.updateEditorStats();
                    } catch (error) {
                        console.error('Insert table failed:', error);
                    }
                }
            }

            insertQuote() {
                const quote = prompt('Enter the quote text:');
                if (quote) {
                    const author = prompt('Enter the author (optional):') || '';
                    const quoteHtml = `
                        <blockquote style="border-left: 4px solid #fbbf24; padding-left: 16px; margin: 16px 0; font-style: italic; color: #64748b;">
                            "${quote}"
                            ${author ? `<footer style="margin-top: 8px; font-size: 0.9em;">— ${author}</footer>` : ''}
                        </blockquote>
                    `;

                    try {
                        document.execCommand('insertHTML', false, quoteHtml);
                        document.getElementById('article-content').focus();
                        this.updateEditorStats();
                    } catch (error) {
                        console.error('Insert quote failed:', error);
                    }
                }
            }

            toggleEditorMode() {
                const visualEditor = document.getElementById('article-content');
                const htmlEditor = document.getElementById('article-content-html');
                const toggleBtn = document.getElementById('html-view-btn');

                if (visualEditor.style.display === 'none') {
                    // Switch to visual mode
                    htmlEditor.style.display = 'none';
                    visualEditor.style.display = 'block';
                    visualEditor.innerHTML = htmlEditor.value;
                    toggleBtn.classList.remove('active');
                    this.updateEditorStats();
                } else {
                    // Switch to HTML mode
                    visualEditor.style.display = 'none';
                    htmlEditor.style.display = 'block';
                    htmlEditor.value = visualEditor.innerHTML;
                    toggleBtn.classList.add('active');
                }
            }

            toggleFullscreen() {
                const modal = document.getElementById('article-editor-modal');
                const toggleBtn = document.getElementById('fullscreen-btn');

                if (modal.classList.contains('editor-fullscreen')) {
                    modal.classList.remove('editor-fullscreen');
                    toggleBtn.classList.remove('active');
                } else {
                    modal.classList.add('editor-fullscreen');
                    toggleBtn.classList.add('active');
                }
            }

            updateEditorStats() {
                const editor = document.getElementById('article-content');
                if (!editor) return;

                const text = editor.innerText || editor.textContent || '';
                const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                const chars = text.length;
                const readingTime = Math.ceil(words / 200); // Average reading speed

                const wordCountEl = document.getElementById('word-count');
                const charCountEl = document.getElementById('char-count');
                const readingTimeEl = document.getElementById('reading-time');

                if (wordCountEl) wordCountEl.textContent = `${words} words`;
                if (charCountEl) charCountEl.textContent = `${chars} characters`;
                if (readingTimeEl) readingTimeEl.textContent = `~${readingTime} min read`;
            }

            handleAutoSave() {
                // Clear existing timeout
                if (this.autoSaveTimeout) {
                    clearTimeout(this.autoSaveTimeout);
                }

                // Set new timeout for auto-save
                this.autoSaveTimeout = setTimeout(() => {
                    const saveStatus = document.getElementById('editor-status');
                    const autoSaveIndicator = document.getElementById('auto-save-indicator');

                    if (saveStatus && this.currentEditingArticle) {
                        saveStatus.textContent = 'Auto-saving...';
                        if (autoSaveIndicator) autoSaveIndicator.classList.remove('hidden');

                        // Simulate auto-save (you can implement actual auto-save here)
                        setTimeout(() => {
                            saveStatus.textContent = 'Saved';
                            if (autoSaveIndicator) autoSaveIndicator.classList.add('hidden');

                            // Clear status after 2 seconds
                            setTimeout(() => {
                                saveStatus.textContent = '';
                            }, 2000);
                        }, 1000);
                    }
                }, 3000); // Auto-save after 3 seconds of inactivity
            }

            // Media Library Functions
            openMediaLibrary(callback = null) {
                this.mediaSelectionCallback = callback;
                const modal = document.getElementById('media-library-modal');
                modal.classList.remove('hidden');
                this.loadMediaLibrary();
            }

            closeMediaLibrary() {
                const modal = document.getElementById('media-library-modal');
                modal.classList.add('hidden');
                this.mediaSelectionCallback = null;
                this.selectedMedia = null;
                this.updateSelectButton();
            }

            async loadMediaLibrary() {
                const mediaGrid = document.getElementById('media-grid');
                const emptyState = document.getElementById('media-empty-state');

                // Show loading state
                mediaGrid.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                        <p class="text-slate-600 dark:text-slate-400">Loading media...</p>
                    </div>
                `;

                try {
                    // For now, we'll use a mock media library
                    // In a real implementation, this would fetch from your media storage
                    const mockMedia = [
                        {
                            id: '1',
                            name: 'hero-image.jpg',
                            url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400',
                            type: 'image',
                            size: '245 KB',
                            uploadedAt: '2024-01-15'
                        },
                        {
                            id: '2',
                            name: 'community-event.jpg',
                            url: 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=400',
                            type: 'image',
                            size: '312 KB',
                            uploadedAt: '2024-01-14'
                        },
                        {
                            id: '3',
                            name: 'dominican-flag.jpg',
                            url: 'https://images.unsplash.com/photo-1582564286939-8e4b7b6b4b4b?w=400',
                            type: 'image',
                            size: '189 KB',
                            uploadedAt: '2024-01-13'
                        }
                    ];

                    if (mockMedia.length === 0) {
                        mediaGrid.innerHTML = '';
                        emptyState.classList.remove('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                        this.renderMediaGrid(mockMedia);
                    }

                    this.updateMediaStats(mockMedia);

                } catch (error) {
                    console.error('Error loading media library:', error);
                    mediaGrid.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p class="text-red-600 dark:text-red-400">Error loading media library</p>
                        </div>
                    `;
                }
            }

            renderMediaGrid(mediaItems) {
                const mediaGrid = document.getElementById('media-grid');

                mediaGrid.innerHTML = mediaItems.map(item => `
                    <div class="media-item group relative bg-white dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden cursor-pointer hover:shadow-lg transition-all"
                         onclick="adminDashboard.selectMediaItem('${item.id}', '${item.url}', '${item.name}')"
                         data-media-id="${item.id}">
                        <div class="aspect-square relative">
                            ${item.type === 'image' ?
                                `<img src="${item.url}" alt="${item.name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center">
                                    <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>`
                            }
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all"></div>
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="event.stopPropagation(); adminDashboard.deleteMedia('${item.id}')"
                                        class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-full">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-3">
                            <p class="text-sm font-medium text-slate-800 dark:text-slate-200 truncate" title="${item.name}">${item.name}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">${item.size} • ${item.uploadedAt}</p>
                        </div>
                    </div>
                `).join('');
            }

            selectMediaItem(id, url, name) {
                // Remove previous selection
                document.querySelectorAll('.media-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-blue-500');
                });

                // Add selection to clicked item
                const selectedItem = document.querySelector(`[data-media-id="${id}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('ring-2', 'ring-blue-500');
                }

                this.selectedMedia = { id, url, name };
                this.updateSelectButton();
            }

            updateSelectButton() {
                const selectBtn = document.getElementById('select-media-btn');
                if (this.selectedMedia) {
                    selectBtn.disabled = false;
                    selectBtn.textContent = `Select "${this.selectedMedia.name}"`;
                } else {
                    selectBtn.disabled = true;
                    selectBtn.textContent = 'Select Media';
                }
            }

            selectMedia() {
                if (this.selectedMedia && this.mediaSelectionCallback) {
                    this.mediaSelectionCallback(this.selectedMedia);
                    this.closeMediaLibrary();
                }
            }

            updateMediaStats(mediaItems) {
                const countEl = document.getElementById('media-count');
                const storageEl = document.getElementById('media-storage');

                if (countEl) countEl.textContent = `${mediaItems.length} items`;
                if (storageEl) {
                    const totalSize = mediaItems.reduce((sum, item) => {
                        const sizeNum = parseFloat(item.size.replace(/[^\d.]/g, ''));
                        return sum + sizeNum;
                    }, 0);
                    storageEl.textContent = `${totalSize.toFixed(1)} MB used`;
                }
            }

            uploadMedia() {
                // Create file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,video/*,.pdf,.doc,.docx';
                input.multiple = true;

                input.onchange = (e) => {
                    const files = Array.from(e.target.files);
                    this.handleMediaUpload(files);
                };

                input.click();
            }

            async handleMediaUpload(files) {
                this.showToast(`Uploading ${files.length} file(s)...`, 'info');

                // In a real implementation, you would upload to your storage service
                // For now, we'll simulate the upload
                try {
                    for (const file of files) {
                        console.log('Uploading file:', file.name);
                        // Simulate upload delay
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    this.showToast('Files uploaded successfully!', 'success');
                    this.loadMediaLibrary(); // Refresh the library
                } catch (error) {
                    console.error('Upload failed:', error);
                    this.showToast('Upload failed. Please try again.', 'error');
                }
            }

            deleteMedia(mediaId) {
                if (confirm('Are you sure you want to delete this media file?')) {
                    // In a real implementation, you would delete from your storage service
                    this.showToast('Media file deleted', 'success');
                    this.loadMediaLibrary(); // Refresh the library
                }
            }

            updateImagePreview(url) {
                const preview = document.getElementById('image-preview');
                const img = document.getElementById('preview-img');

                if (url && url.trim()) {
                    img.src = url;
                    img.onload = () => {
                        preview.classList.remove('hidden');
                    };
                    img.onerror = () => {
                        preview.classList.add('hidden');
                    };
                } else {
                    preview.classList.add('hidden');
                }
            }

            async deleteArticle(articleId) {
                if (!confirm('Are you sure you want to delete this article?')) return;

                try {
                    const response = await this.makeAPICall(`/articles/${articleId}`, 'DELETE');
                    if (response.success) {
                        this.showToast('Article deleted successfully!', 'success');
                        this.loadArticles(); // Refresh the list
                    }
                } catch (error) {
                    console.error('Error deleting article:', error);
                    this.showToast('Error deleting article', 'error');
                }
            }

            async setFeaturedArticle(articleId) {
                try {
                    console.log('⭐ Setting article as featured:', articleId);

                    // First, unset any currently featured articles
                    await this.unsetAllFeaturedArticles();

                    // Then set this article as featured
                    const response = await this.setFeaturedArticleInSupabase(articleId);

                    if (response.success) {
                        this.showToast('Article set as featured successfully!', 'success');
                        this.loadArticles(); // Refresh the list
                        // Refresh dashboard if we're on it
                        if (this.currentSection === 'dashboard') {
                            this.loadDashboard();
                        }
                    } else {
                        this.showToast(response.error?.message || 'Failed to set article as featured', 'error');
                    }
                } catch (error) {
                    console.error('Error setting featured article:', error);
                    this.showToast('Error setting article as featured', 'error');
                }
            }

            async setFeaturedArticleInSupabase(articleId) {
                try {
                    console.log('🔄 Setting article as featured in Supabase:', articleId);

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/articles?id=eq.${articleId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            isFeatured: true
                        })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`Supabase update failed: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    console.log('✅ Article set as featured in Supabase:', result);

                    return {
                        success: true,
                        data: result[0]
                    };
                } catch (error) {
                    console.error('❌ Supabase set featured article failed:', error);
                    return {
                        success: false,
                        error: { message: error.message }
                    };
                }
            }

            async unsetAllFeaturedArticles() {
                try {
                    console.log('🔄 Unsetting all featured articles in Supabase...');

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/articles?isFeatured=eq.true`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseAnonKey,
                            'Authorization': `Bearer ${this.supabaseAnonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            isFeatured: false
                        })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        console.warn('Failed to unset featured articles:', error);
                    } else {
                        console.log('✅ All featured articles unset');
                    }
                } catch (error) {
                    console.warn('Error unsetting featured articles:', error);
                }
            }

            async unsetFeaturedArticle(articleId) {
                try {
                    console.log('🔄 Removing featured status from article:', articleId);
                    const response = await this.makeAPICall(`/articles/${articleId}/feature`, 'DELETE');
                    if (response.success) {
                        this.showToast('Article unfeatured successfully!', 'success');
                        this.featuredArticle = null; // Clear featured article
                        this.loadArticles(); // Refresh the list
                        // Refresh dashboard if we're on it
                        if (this.currentSection === 'dashboard') {
                            this.loadDashboard();
                        }
                    } else {
                        this.showToast(response.error?.message || 'Failed to unfeature article', 'error');
                    }
                } catch (error) {
                    console.error('Error unfeaturing article:', error);
                    this.showToast('Error unfeaturing article', 'error');
                }
            }

            // Article Scheduling and SEO Functions
            handleStatusChange(status) {
                const publishDateContainer = document.getElementById('publish-date-container');
                const publishDateLabel = document.getElementById('publish-date-label');
                const publishDateHelp = document.getElementById('publish-date-help');

                if (status === 'SCHEDULED') {
                    publishDateContainer.classList.remove('hidden');
                    publishDateLabel.textContent = 'Schedule for';
                    publishDateHelp.textContent = 'Select when this article should be published';

                    // Set minimum date to current time
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    document.getElementById('article-publish-date').min = now.toISOString().slice(0, 16);
                } else if (status === 'PUBLISHED') {
                    publishDateContainer.classList.remove('hidden');
                    publishDateLabel.textContent = 'Published Date & Time';
                    publishDateHelp.textContent = 'When this article was published (leave empty for current time)';

                    // Remove minimum date restriction
                    document.getElementById('article-publish-date').removeAttribute('min');
                } else {
                    publishDateContainer.classList.add('hidden');
                }
            }

            updateMetaCharCount() {
                const metaDescription = document.getElementById('article-meta-description');
                const charCount = document.getElementById('meta-char-count');

                if (metaDescription && charCount) {
                    const length = metaDescription.value.length;
                    charCount.textContent = `${length}/160`;

                    // Change color based on length
                    if (length > 160) {
                        charCount.className = 'text-xs text-red-500';
                    } else if (length > 140) {
                        charCount.className = 'text-xs text-yellow-500';
                    } else {
                        charCount.className = 'text-xs text-slate-500 dark:text-slate-400';
                    }
                }
            }

            // Enhanced article saving with new fields
            async saveArticle() {
                const form = document.getElementById('article-editor-form');
                const formData = new FormData(form);

                // Get content from editor
                const contentEditor = document.getElementById('article-content');
                const htmlEditor = document.getElementById('article-content-html');

                // Check which editor is currently visible and get content from the active one
                let content;
                if (htmlEditor && !htmlEditor.classList.contains('hidden') && htmlEditor.style.display !== 'none') {
                    // HTML editor is active
                    content = htmlEditor.value;
                } else {
                    // Visual editor is active (default)
                    content = contentEditor ? contentEditor.innerHTML : '';
                }

                console.log('📝 Content extraction debug:', {
                    htmlEditorHidden: htmlEditor?.classList.contains('hidden'),
                    htmlEditorDisplay: htmlEditor?.style.display,
                    visualEditorContent: contentEditor?.innerHTML?.substring(0, 100),
                    htmlEditorContent: htmlEditor?.value?.substring(0, 100),
                    finalContent: content?.substring(0, 100)
                });

                // Prepare article data with new fields
                const articleData = {
                    title: formData.get('title'),
                    summary: formData.get('summary'),
                    content: content,
                    imageUrl: formData.get('imageUrl'),
                    authorId: formData.get('authorId'),
                    categoryId: formData.get('categoryId'),
                    status: formData.get('status'),
                    publishedAt: formData.get('publishedAt') || null,
                    metaDescription: formData.get('metaDescription') || null,
                    tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    featured: formData.get('featured') === 'on'
                };

                // Debug validation
                console.log('🔍 Validation Debug:', {
                    title: articleData.title,
                    summary: articleData.summary,
                    content: articleData.content,
                    contentLength: articleData.content?.length,
                    authorId: articleData.authorId,
                    categoryId: articleData.categoryId
                });

                // Validation with better content checking
                if (!articleData.title || !articleData.title.trim()) {
                    this.showToast('Please enter a title', 'error');
                    return;
                }
                if (!articleData.summary || !articleData.summary.trim()) {
                    this.showToast('Please enter a summary', 'error');
                    return;
                }
                if (!articleData.content || !articleData.content.trim() || articleData.content.trim() === '<br>' || articleData.content.trim() === '&nbsp;') {
                    this.showToast('Please enter article content', 'error');
                    return;
                }
                if (!articleData.authorId) {
                    this.showToast('Please select an author', 'error');
                    return;
                }
                if (!articleData.categoryId) {
                    this.showToast('Please select a category', 'error');
                    return;
                }

                // Validate scheduled date
                if (articleData.status === 'SCHEDULED') {
                    if (!articleData.publishedAt) {
                        this.showToast('Please select a publish date for scheduled articles', 'error');
                        return;
                    }

                    const scheduledDate = new Date(articleData.publishedAt);
                    const now = new Date();

                    if (scheduledDate <= now) {
                        this.showToast('Scheduled date must be in the future', 'error');
                        return;
                    }
                }

                // Show saving state
                const saveBtn = document.getElementById('save-btn-text');
                const saveSpinner = document.getElementById('save-spinner');
                const saveStatus = document.getElementById('save-status');

                saveBtn.textContent = 'Saving...';
                saveSpinner.classList.remove('hidden');
                saveStatus.textContent = 'Saving article...';

                try {
                    let response;
                    if (this.currentEditingArticle) {
                        // Update existing article using existing Supabase method
                        response = await this.updateArticleInSupabase(this.currentEditingArticle.id, articleData);
                    } else {
                        // Create new article using existing Supabase method
                        response = await this.createArticleInSupabase(articleData);
                    }

                    if (response.success) {
                        const action = this.currentEditingArticle ? 'updated' : 'created';
                        const statusMessage = articleData.status === 'SCHEDULED' ?
                            `Article ${action} and scheduled for ${new Date(articleData.publishedAt).toLocaleString()}` :
                            `Article ${action} successfully`;

                        this.showToast(statusMessage, 'success');
                        this.closeArticleEditor();
                        this.loadArticles(); // Refresh the articles list
                    } else {
                        throw new Error(response.error?.message || 'Failed to save article');
                    }
                } catch (error) {
                    console.error('Error saving article:', error);
                    this.showToast('Failed to save article. Please try again.', 'error');
                } finally {
                    // Reset button state
                    saveBtn.textContent = this.currentEditingArticle ? 'Update Article' : 'Save Article';
                    saveSpinner.classList.add('hidden');
                    saveStatus.textContent = '';
                }
            }

            async openFeaturedArticleSelector() {
                try {
                    console.log('🔄 Loading published articles for featured selection...');
                    const response = await this.makeAPICall('/articles?status=PUBLISHED&limit=50');

                    if (!response.success) {
                        this.showToast('Failed to load articles', 'error');
                        return;
                    }

                    const publishedArticles = response.data || [];
                    console.log(`✅ Loaded ${publishedArticles.length} published articles`);

                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    modal.innerHTML = `
                        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200">Select Featured Article</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="p-6">
                                <div class="mb-4">
                                    <input type="text" id="featured-search" placeholder="Search articles..."
                                           class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100">
                                </div>

                                <div class="max-h-96 overflow-y-auto" id="featured-articles-list">
                                    ${publishedArticles.length > 0 ? publishedArticles.map(article => `
                                        <div class="article-item border border-slate-200 dark:border-slate-700 rounded-lg p-4 mb-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer transition-colors ${article.isFeatured ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-300 dark:border-yellow-600' : ''}"
                                             onclick="adminDashboard.selectFeaturedArticle('${article.id}', this.closest('.fixed'))"
                                             data-title="${article.title.toLowerCase()}"
                                             data-author="${(article.author?.name || '').toLowerCase()}">
                                            <div class="flex gap-4">
                                                <img src="${article.imageUrl || 'https://images.unsplash.com/photo-1495020689067-958852a7765e?ixlib=rb-4.0.3&auto=format&fit=crop&w=150&q=80'}"
                                                     alt="${article.title}"
                                                     class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
                                                <div class="flex-grow">
                                                    <div class="flex items-start justify-between">
                                                        <h4 class="font-semibold text-slate-800 dark:text-slate-200 mb-1">${article.title}</h4>
                                                        ${article.isFeatured ? '<span class="text-yellow-600 dark:text-yellow-400 text-sm font-medium">★ Currently Featured</span>' : ''}
                                                    </div>
                                                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">
                                                        By ${article.author?.name || 'Unknown Author'} •
                                                        ${new Date(article.publishedAt || article.createdAt).toLocaleDateString()}
                                                    </p>
                                                    <p class="text-sm text-slate-700 dark:text-slate-300 line-clamp-2">${article.summary || 'No summary available'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-center text-slate-500 py-8">No published articles available</p>'}
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);

                    // Add search functionality
                    const searchInput = modal.querySelector('#featured-search');
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const articles = modal.querySelectorAll('.article-item');

                        articles.forEach(article => {
                            const title = article.dataset.title;
                            const author = article.dataset.author;
                            const matches = title.includes(searchTerm) || author.includes(searchTerm);
                            article.style.display = matches ? 'block' : 'none';
                        });
                    });

                } catch (error) {
                    console.error('Error opening featured article selector:', error);
                    this.showToast('Error loading article selector', 'error');
                }
            }

            async selectFeaturedArticle(articleId, modal) {
                try {
                    console.log('⭐ Setting new featured article:', articleId);

                    // First, unset any currently featured articles
                    await this.unsetAllFeaturedArticles();

                    // Then set this article as featured
                    const response = await this.setFeaturedArticleInSupabase(articleId);

                    if (response.success) {
                        this.showToast('Featured article updated successfully!', 'success');
                        modal.remove();

                        // Refresh data
                        await this.loadDashboard();
                        if (this.currentSection === 'articles') {
                            this.loadArticles();
                        }
                    } else {
                        this.showToast(response.error?.message || 'Failed to set featured article', 'error');
                    }
                } catch (error) {
                    console.error('Error setting featured article:', error);
                    this.showToast('Error setting featured article', 'error');
                }
            }

            async loadAuthors() {
                try {
                    const response = await this.makeAPICall('/authors?limit=50');
                    this.authors = response.data || [];

                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = `
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200">Authors</h2>
                                <p class="text-slate-600 dark:text-slate-400 mt-2">Manage article authors and contributors.</p>
                            </div>
                            <button onclick="adminDashboard.createAuthor()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg btn-primary flex items-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <span>New Author</span>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${this.authors.map(author => `
                                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 admin-card border-l-4 ${author.isActive ? 'border-green-500' : 'border-gray-400'}">
                                    <div class="flex items-start space-x-4">
                                        <div class="relative">
                                            <img src="${author.avatarUrl || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-4.0.3&auto=format&fit=crop&w=60&q=60'}" alt="${author.name}" class="w-16 h-16 rounded-full object-cover border-2 border-slate-200 dark:border-slate-600">
                                            <div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${author.isActive ? 'bg-green-500' : 'bg-gray-400'} border-2 border-white dark:border-slate-800"></div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200 truncate">${author.name}</h3>
                                            <p class="text-sm text-slate-500 dark:text-slate-400 truncate">${author.email}</p>
                                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-1 line-clamp-2">${author.bio || 'No bio available'}</p>
                                            <div class="flex items-center justify-between mt-2">
                                                <span class="text-xs font-medium ${(author.articleCount || 0) > 0 ? 'text-blue-600 dark:text-blue-400' : 'text-slate-500 dark:text-slate-500'}">${author.articleCount || 0} articles</span>
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${author.isActive ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200'}">${author.isActive ? 'Active' : 'Inactive'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex space-x-2">
                                        <button onclick="adminDashboard.editAuthor('${author.id}')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm btn-primary flex items-center justify-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            <span>Edit</span>
                                        </button>
                                        <button onclick="adminDashboard.deleteAuthor('${author.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm btn-primary flex items-center justify-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            <span>Delete</span>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading authors:', error);
                    this.showToast('Error loading authors', 'error');
                }
            }

            async createAuthor() {
                console.log('🆕 Opening author creation modal...');
                this.currentEditingAuthor = null;
                this.openAuthorEditor();
            }

            async editAuthor(authorId) {
                console.log('✏️ Opening author editor for:', authorId);
                try {
                    // Load the author data
                    const response = await this.makeAPICall(`/authors/${authorId}`);
                    if (response.success && response.data) {
                        this.currentEditingAuthor = response.data;
                        this.openAuthorEditor(response.data);
                    } else {
                        this.showToast('Failed to load author data', 'error');
                    }
                } catch (error) {
                    console.error('Error loading author:', error);
                    this.showToast('Error loading author data', 'error');
                }
            }

            openAuthorEditor(author = null) {
                const modal = document.getElementById('author-editor-modal');
                const title = document.getElementById('author-editor-modal-title');
                const form = document.getElementById('author-editor-form');

                // Set modal title
                title.textContent = author ? 'Edit Author' : 'Create New Author';

                // Populate form if editing
                if (author) {
                    this.populateAuthorForm(author);
                } else {
                    form.reset();
                    document.getElementById('avatar-preview').classList.add('hidden');
                }

                // Show modal
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Focus on name field
                setTimeout(() => {
                    document.getElementById('author-name').focus();
                }, 100);
            }

            closeAuthorEditor() {
                const modal = document.getElementById('author-editor-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
                this.currentEditingAuthor = null;
            }

            populateAuthorForm(author) {
                document.getElementById('author-name').value = author.name || '';
                document.getElementById('author-email').value = author.email || '';
                document.getElementById('author-avatar').value = author.avatarUrl || '';
                document.getElementById('author-bio').value = author.bio || '';
                document.getElementById('author-status').value = author.isActive ? 'true' : 'false';

                // Show avatar preview if URL exists
                if (author.avatarUrl) {
                    this.updateAvatarPreview(author.avatarUrl);
                }

                // Update bio character count
                this.updateBioCharCount();
            }

            async saveAuthor() {
                const form = document.getElementById('author-editor-form');
                const formData = new FormData(form);
                const saveBtn = document.getElementById('author-save-btn-text');
                const saveSpinner = document.getElementById('author-save-spinner');
                const saveStatus = document.getElementById('author-save-status');

                // Validate required fields
                const name = formData.get('name');
                const email = formData.get('email');

                if (!name || !email) {
                    this.showToast('Please fill in all required fields (Name and Email)', 'error');
                    return;
                }

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email.trim())) {
                    this.showToast('Please enter a valid email address', 'error');
                    return;
                }

                // Validate name length
                if (name.trim().length < 2) {
                    this.showToast('Author name must be at least 2 characters long', 'error');
                    return;
                }

                try {
                    saveBtn.textContent = 'Saving...';
                    saveSpinner.classList.remove('hidden');
                    saveStatus.textContent = 'Saving author...';

                    const authorData = {
                        name: name.trim(),
                        email: email.trim().toLowerCase(),
                        bio: formData.get('bio')?.trim() || null,
                        avatarUrl: formData.get('avatarUrl')?.trim() || null,
                        isActive: formData.get('isActive') === 'true'
                    };

                    // Validate avatar URL if provided
                    if (authorData.avatarUrl && !this.isValidUrl(authorData.avatarUrl)) {
                        this.showToast('Please enter a valid avatar URL', 'error');
                        return;
                    }

                    let response;
                    if (this.currentEditingAuthor) {
                        // Update existing author
                        response = await this.makeAPICall(`/authors/${this.currentEditingAuthor.id}`, 'PUT', authorData);
                    } else {
                        // Create new author
                        response = await this.makeAPICall('/authors', 'POST', authorData);
                    }

                    if (response.success) {
                        this.showToast(
                            this.currentEditingAuthor ? 'Author updated successfully!' : 'Author created successfully!',
                            'success'
                        );
                        this.closeAuthorEditor();

                        // Refresh the authors list and update dropdowns
                        if (this.currentSection === 'authors') {
                            this.loadAuthors();
                        } else if (this.currentSection === 'dashboard') {
                            this.loadDashboard();
                        }

                        // Update author dropdowns in article editor
                        this.loadAuthorDropdown();
                    } else {
                        throw new Error(response.error?.message || 'Failed to save author');
                    }
                } catch (error) {
                    console.error('Error saving author:', error);
                    this.showToast('Error saving author: ' + error.message, 'error');
                } finally {
                    saveBtn.textContent = 'Save Author';
                    saveSpinner.classList.add('hidden');
                    saveStatus.textContent = '';
                }
            }

            updateAvatarPreview(url) {
                const preview = document.getElementById('avatar-preview');
                const img = document.getElementById('preview-avatar');

                if (url && url.trim()) {
                    img.src = url;
                    img.onload = () => {
                        preview.classList.remove('hidden');
                    };
                    img.onerror = () => {
                        preview.classList.add('hidden');
                    };
                } else {
                    preview.classList.add('hidden');
                }
            }

            async loadAuthorDropdown() {
                try {
                    const authorSelect = document.getElementById('article-author');
                    if (!authorSelect) return;

                    // Fetch latest authors
                    const response = await this.makeAPICall('/authors');
                    if (response.success && response.data) {
                        // Clear existing options
                        authorSelect.innerHTML = '<option value="">Select an author...</option>';

                        // Add authors to dropdown
                        response.data.forEach(author => {
                            if (author.isActive !== false) { // Only show active authors
                                const option = document.createElement('option');
                                option.value = author.id;
                                option.textContent = author.name;
                                authorSelect.appendChild(option);
                            }
                        });

                        console.log(`✅ Updated author dropdown with ${response.data.length} authors`);
                    }
                } catch (error) {
                    console.error('Error loading author dropdown:', error);
                }
            }

            updateBioCharCount() {
                const bioField = document.getElementById('author-bio');
                const charCount = document.getElementById('bio-char-count');

                if (bioField && charCount) {
                    const currentLength = bioField.value.length;
                    const maxLength = 500;
                    charCount.textContent = `${currentLength}/${maxLength}`;

                    // Change color based on character count
                    if (currentLength > maxLength * 0.9) {
                        charCount.className = 'text-xs text-red-500 dark:text-red-400';
                    } else if (currentLength > maxLength * 0.7) {
                        charCount.className = 'text-xs text-yellow-500 dark:text-yellow-400';
                    } else {
                        charCount.className = 'text-xs text-slate-500 dark:text-slate-400';
                    }
                }
            }

            async loadGalleryCategoryDropdown() {
                try {
                    const categorySelect = document.getElementById('gallery-category');
                    if (!categorySelect) return;

                    // Fetch latest gallery categories
                    const response = await this.makeAPICall('/gallery-categories');
                    if (response.success && response.data) {
                        // Clear existing options
                        categorySelect.innerHTML = '<option value="">Select a category...</option>';

                        // Add categories to dropdown
                        response.data.forEach(category => {
                            if (category.isActive !== false) { // Only show active categories
                                const option = document.createElement('option');
                                option.value = category.id;
                                option.textContent = category.name;
                                categorySelect.appendChild(option);
                            }
                        });

                        console.log(`✅ Updated gallery category dropdown with ${response.data.length} categories`);
                    }
                } catch (error) {
                    console.error('Error loading gallery category dropdown:', error);
                }
            }

            async deleteAuthor(authorId) {
                if (!confirm('Are you sure you want to delete this author?')) return;

                try {
                    const response = await this.makeAPICall(`/authors/${authorId}`, 'DELETE');
                    if (response.success) {
                        this.showToast('Author deleted successfully!', 'success');
                        this.loadAuthors(); // Refresh the list
                    }
                } catch (error) {
                    console.error('Error deleting author:', error);
                    this.showToast('Error deleting author', 'error');
                }
            }

            async loadCategories() {
                try {
                    console.log('📂 Loading categories...');

                    // Fetch categories from API
                    const response = await this.makeAPICall('/categories');
                    this.categories = response.data || [];

                    console.log(`✅ Loaded ${this.categories.length} categories`);

                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = `
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200">Categories Management</h2>
                                <p class="text-slate-600 dark:text-slate-400 mt-2">Organize your articles with categories.</p>
                                <div class="mt-2 text-sm text-green-600 dark:text-green-400">
                                    ✅ Data loaded from backend API (${this.categories.length} categories)
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="adminDashboard.createCategory()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg btn-primary flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>Add Category</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 shadow-sm rounded-lg border border-slate-200 dark:border-slate-700">
                            <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">All Categories</h3>
                                    <div class="flex items-center space-x-4">
                                        <div class="relative">
                                            <input type="text" id="category-search" placeholder="Search categories..."
                                                   class="pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                   oninput="adminDashboard.filterCategories(this.value)">
                                            <svg class="absolute left-3 top-2.5 h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                <div id="categories-grid">
                                    ${this.categories.length > 0 ? `
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            ${this.categories.map(category => `
                                                <div class="category-card bg-slate-50 dark:bg-slate-700 rounded-lg p-6 border border-slate-200 dark:border-slate-600 hover:shadow-md transition-shadow">
                                                    <div class="flex items-center space-x-3 mb-4">
                                                        <div class="w-6 h-6 rounded-full flex-shrink-0" style="background-color: ${category.color || '#6B7280'}"></div>
                                                        <div class="flex-1 min-w-0">
                                                            <h4 class="text-lg font-medium text-slate-900 dark:text-slate-100 truncate">${category.name}</h4>
                                                            <p class="text-sm text-slate-500 dark:text-slate-400 truncate">/${category.slug}</p>
                                                        </div>
                                                    </div>
                                                    ${category.description ? `<p class="text-sm text-slate-600 dark:text-slate-400 mb-4 line-clamp-3">${category.description}</p>` : ''}
                                                    <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                                                        <span>${category._count?.articles || 0} articles</span>
                                                        <div class="flex space-x-2">
                                                            <button onclick="adminDashboard.editCategory('${category.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 font-medium">Edit</button>
                                                            <button onclick="adminDashboard.deleteCategory('${category.id}', '${category.name}')" class="text-red-600 hover:text-red-800 dark:text-red-400 font-medium">Delete</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="text-center py-12">
                                            <div class="text-slate-400 dark:text-slate-500 text-6xl mb-4">🏷️</div>
                                            <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100 mb-2">No categories yet</h3>
                                            <p class="text-slate-500 dark:text-slate-400 mb-6">Create categories to organize your articles</p>
                                            <button onclick="adminDashboard.createCategory()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg">Create First Category</button>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading categories:', error);
                    this.showToast('Error loading categories', 'error');
                }
            }

            // Category Management Methods
            async createCategory() {
                console.log('🆕 Opening category creation modal...');
                this.currentEditingCategory = null;
                this.openCategoryEditor(null);
            }

            async editCategory(categoryId) {
                console.log('✏️ Opening category edit modal for:', categoryId);
                const category = this.categories.find(c => c.id === categoryId);
                if (category) {
                    console.log('📋 Found category data:', category);
                    this.currentEditingCategory = category;
                    this.openCategoryEditor(category);
                } else {
                    console.error('❌ Category not found in local data:', categoryId);
                    this.showToast('Category not found', 'error');
                }
            }

            async deleteCategory(categoryId, categoryName) {
                if (confirm(`Are you sure you want to delete the category "${categoryName}"? This action cannot be undone.`)) {
                    try {
                        console.log('🗑️ Deleting category:', categoryId);
                        await this.makeAPICall(`/categories/${categoryId}`, 'DELETE');
                        this.showToast('Category deleted successfully', 'success');
                        await this.loadCategories(); // Reload the list
                    } catch (error) {
                        console.error('Error deleting category:', error);
                        this.showToast('Error deleting category', 'error');
                    }
                }
            }

            filterCategories(searchTerm) {
                const cards = document.querySelectorAll('.category-card');
                const lowerSearchTerm = searchTerm.toLowerCase();

                cards.forEach(card => {
                    const categoryName = card.querySelector('h4').textContent.toLowerCase();
                    const categorySlug = card.querySelector('p').textContent.toLowerCase();
                    const categoryDescription = card.querySelector('.line-clamp-3')?.textContent?.toLowerCase() || '';

                    const matches = categoryName.includes(lowerSearchTerm) ||
                                  categorySlug.includes(lowerSearchTerm) ||
                                  categoryDescription.includes(lowerSearchTerm);

                    card.style.display = matches ? 'block' : 'none';
                });
            }

            openCategoryEditor(category = null) {
                const modal = document.getElementById('category-editor-modal');
                const title = document.getElementById('category-editor-modal-title');
                const form = document.getElementById('category-editor-form');

                // Set modal title
                title.textContent = category ? 'Edit Category' : 'Add Category';

                // Show modal first
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                // Wait a moment for DOM to be ready, then populate form
                setTimeout(() => {
                    if (category) {
                        console.log('📝 Populating form with category data:', category);
                        this.populateCategoryForm(category);
                    } else {
                        console.log('🆕 Setting up form for new category');
                        form.reset();
                        const colorField = document.getElementById('category-color');
                        const colorTextField = document.getElementById('category-color-text');
                        if (colorField) colorField.value = '#6B7280';
                        if (colorTextField) colorTextField.value = '#6B7280';
                    }

                    // Focus on the name field
                    const nameField = document.getElementById('category-name');
                    if (nameField) nameField.focus();
                }, 150);
            }

            populateCategoryForm(category) {
                console.log('🔧 Populating category form with:', category);

                // Get form elements
                const nameField = document.getElementById('category-name');
                const slugField = document.getElementById('category-slug');
                const descriptionField = document.getElementById('category-description');
                const colorField = document.getElementById('category-color');
                const colorTextField = document.getElementById('category-color-text');

                // Check if elements exist
                if (!nameField || !slugField || !descriptionField || !colorField || !colorTextField) {
                    console.error('❌ Category form elements not found in DOM');
                    return;
                }

                // Populate fields
                nameField.value = category.name || '';
                slugField.value = category.slug || '';
                descriptionField.value = category.description || '';
                colorField.value = category.color || '#6B7280';
                colorTextField.value = category.color || '#6B7280';

                // Store the original name for slug generation
                slugField.dataset.previousName = category.name || '';

                console.log('✅ Category form populated successfully');
            }

            closeCategoryEditor() {
                const modal = document.getElementById('category-editor-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                this.currentEditingCategory = null;
            }

            generateSlug(name) {
                return name
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }

            async saveCategoryForm() {
                const form = document.getElementById('category-editor-form');
                const formData = new FormData(form);

                const categoryData = {
                    name: formData.get('name'),
                    slug: formData.get('slug') || this.generateSlug(formData.get('name')),
                    description: formData.get('description'),
                    color: formData.get('color')
                };

                try {
                    if (this.currentEditingCategory) {
                        // Update existing category
                        console.log('💾 Updating category:', this.currentEditingCategory.id);
                        await this.makeAPICall(`/categories/${this.currentEditingCategory.id}`, 'PUT', categoryData);
                        this.showToast('Category updated successfully', 'success');
                    } else {
                        // Create new category
                        console.log('💾 Creating new category');
                        await this.makeAPICall('/categories', 'POST', categoryData);
                        this.showToast('Category created successfully', 'success');
                    }

                    this.closeCategoryEditor();
                    await this.loadCategories(); // Reload the list
                } catch (error) {
                    console.error('Error saving category:', error);
                    this.showToast('Error saving category', 'error');
                }
            }

            // Category Editor Helper Methods
            updateSlugFromName(name) {
                const slugField = document.getElementById('category-slug');
                if (!slugField.value || slugField.value === this.generateSlug(slugField.dataset.previousName || '')) {
                    slugField.value = this.generateSlug(name);
                }
                slugField.dataset.previousName = name;
            }

            updateColorText(color) {
                document.getElementById('category-color-text').value = color;
            }

            updateColorPicker(color) {
                if (/^#[0-9A-F]{6}$/i.test(color)) {
                    document.getElementById('category-color').value = color;
                }
            }

            async loadAnalytics() {
                const mainContent = document.getElementById('main-content');

                // Show loading state
                mainContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto mb-4"></div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-4">Loading Analytics...</h2>
                        <p class="text-slate-600 dark:text-slate-400">Gathering data from all sources...</p>
                    </div>
                `;

                try {
                    // Fetch all data needed for analytics
                    const [articlesResponse, authorsResponse, categoriesResponse, galleryResponse] = await Promise.all([
                        this.getArticlesFromSupabase(),
                        this.getAuthorsFromSupabase(),
                        this.getCategoriesFromSupabase(),
                        this.getGalleryFromSupabase()
                    ]);

                    const articles = articlesResponse.data || [];
                    const authors = authorsResponse.data || [];
                    const categories = categoriesResponse.data || [];
                    const galleryItems = galleryResponse.data || [];

                    // Calculate analytics data
                    const analytics = this.calculateAnalytics(articles, authors, categories, galleryItems);

                    // Render analytics dashboard
                    this.renderAnalyticsDashboard(analytics, articles, authors, categories, galleryItems);

                } catch (error) {
                    console.error('Error loading analytics:', error);
                    mainContent.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-red-500 text-6xl mb-4">⚠️</div>
                            <h2 class="text-2xl font-bold text-red-600 mb-4">Error Loading Analytics</h2>
                            <p class="text-slate-600 dark:text-slate-400 mb-4">Failed to load analytics data. Please try again.</p>
                            <button onclick="adminDashboard.loadAnalytics()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg btn-primary">
                                Retry
                            </button>
                        </div>
                    `;
                }
            }

            calculateAnalytics(articles, authors, categories, galleryItems) {
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));

                // Basic counts
                const totalArticles = articles.length;
                const publishedArticles = articles.filter(a => a.status === 'PUBLISHED').length;
                const draftArticles = articles.filter(a => a.status === 'DRAFT').length;
                const archivedArticles = articles.filter(a => a.status === 'ARCHIVED').length;

                // Recent activity
                const recentArticles = articles.filter(a => new Date(a.created_at) >= sevenDaysAgo).length;
                const recentGalleryItems = galleryItems.filter(g => new Date(g.created_at) >= sevenDaysAgo).length;

                // Articles by category
                const articlesByCategory = {};
                categories.forEach(cat => {
                    articlesByCategory[cat.name] = articles.filter(a => a.category_id === cat.id).length;
                });

                // Articles by author
                const articlesByAuthor = {};
                authors.forEach(author => {
                    const authorArticles = articles.filter(a => a.author_id === author.id);
                    articlesByAuthor[author.name] = {
                        total: authorArticles.length,
                        published: authorArticles.filter(a => a.status === 'PUBLISHED').length,
                        draft: authorArticles.filter(a => a.status === 'DRAFT').length
                    };
                });

                // Monthly publishing trends (last 6 months)
                const monthlyTrends = {};
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    const nextMonth = new Date(date.getFullYear(), date.getMonth() + 1, 1);

                    monthlyTrends[monthKey] = articles.filter(a => {
                        const articleDate = new Date(a.created_at);
                        return articleDate >= date && articleDate < nextMonth;
                    }).length;
                }

                // Gallery by category
                const galleryByCategory = {};
                if (this.galleryCategories) {
                    this.galleryCategories.forEach(cat => {
                        galleryByCategory[cat.name] = galleryItems.filter(g => g.category_id === cat.id).length;
                    });
                }

                return {
                    overview: {
                        totalArticles,
                        publishedArticles,
                        draftArticles,
                        archivedArticles,
                        totalAuthors: authors.length,
                        totalCategories: categories.length,
                        totalGalleryItems: galleryItems.length,
                        recentArticles,
                        recentGalleryItems,
                        publishingRate: totalArticles > 0 ? Math.round((publishedArticles / totalArticles) * 100) : 0
                    },
                    articlesByCategory,
                    articlesByAuthor,
                    monthlyTrends,
                    galleryByCategory
                };
            }

            renderAnalyticsDashboard(analytics, articles, authors, categories, galleryItems) {
                // Store analytics data for theme changes
                this.lastAnalyticsData = analytics;

                const mainContent = document.getElementById('main-content');

                // Check if we have any data to display
                if (analytics.overview.totalArticles === 0 && analytics.overview.totalAuthors === 0) {
                    mainContent.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-slate-400 text-6xl mb-4">📊</div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-4">No Data Available</h2>
                            <p class="text-slate-600 dark:text-slate-400 mb-6">Start creating content to see analytics insights.</p>
                            <div class="flex justify-center space-x-4">
                                <button onclick="adminDashboard.showSection('articles')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg btn-primary">
                                    Create First Article
                                </button>
                                <button onclick="adminDashboard.showSection('authors')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg btn-primary">
                                    Add Authors
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                mainContent.innerHTML = `
                    <div class="mb-8">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200">Analytics Dashboard</h2>
                                <p class="text-slate-600 dark:text-slate-400 mt-2">Comprehensive insights into your content and engagement.</p>
                                <div class="mt-2 text-sm text-green-600 dark:text-green-400">
                                    ✅ Real-time data from Supabase (${analytics.overview.totalArticles} articles analyzed)
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="adminDashboard.exportAnalytics()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg btn-primary flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span>Export</span>
                                </button>
                                <button onclick="adminDashboard.loadAnalytics()" class="bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded-lg btn-primary flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Overview Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Total Articles -->
                        <div class="stat-card text-white p-6 rounded-xl admin-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/80 text-sm">Total Articles</p>
                                    <p class="text-3xl font-bold">${analytics.overview.totalArticles}</p>
                                    <p class="text-white/80 text-sm mt-1">${analytics.overview.recentArticles} this week</p>
                                </div>
                                <div class="bg-white/20 p-3 rounded-lg">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Published Articles -->
                        <div class="stat-card green text-white p-6 rounded-xl admin-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/80 text-sm">Published</p>
                                    <p class="text-3xl font-bold">${analytics.overview.publishedArticles}</p>
                                    <p class="text-white/80 text-sm mt-1">${analytics.overview.publishingRate}% rate</p>
                                </div>
                                <div class="bg-white/20 p-3 rounded-lg">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Draft Articles -->
                        <div class="stat-card orange text-white p-6 rounded-xl admin-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/80 text-sm">Drafts</p>
                                    <p class="text-3xl font-bold">${analytics.overview.draftArticles}</p>
                                    <p class="text-white/80 text-sm mt-1">In progress</p>
                                </div>
                                <div class="bg-white/20 p-3 rounded-lg">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Authors -->
                        <div class="stat-card purple text-white p-6 rounded-xl admin-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/80 text-sm">Active Authors</p>
                                    <p class="text-3xl font-bold">${analytics.overview.totalAuthors}</p>
                                    <p class="text-white/80 text-sm mt-1">${analytics.overview.totalCategories} categories</p>
                                </div>
                                <div class="bg-white/20 p-3 rounded-lg">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Articles by Status Chart -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Articles by Status</h3>
                            <div class="relative h-64">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <!-- Monthly Publishing Trends -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Publishing Trends (6 Months)</h3>
                            <div class="relative h-64">
                                <canvas id="trendsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Category and Author Analytics -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Articles by Category -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Articles by Category</h3>
                            <div class="relative h-64">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>

                        <!-- Top Authors -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Author Productivity</h3>
                            <div class="relative h-64">
                                <canvas id="authorChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Analytics Tables -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Author Performance Table -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Author Performance</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-slate-200 dark:border-slate-700">
                                            <th class="text-left py-2 text-slate-600 dark:text-slate-400">Author</th>
                                            <th class="text-center py-2 text-slate-600 dark:text-slate-400">Total</th>
                                            <th class="text-center py-2 text-slate-600 dark:text-slate-400">Published</th>
                                            <th class="text-center py-2 text-slate-600 dark:text-slate-400">Drafts</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(analytics.articlesByAuthor)
                                            .sort(([,a], [,b]) => b.total - a.total)
                                            .map(([name, stats]) => `
                                                <tr class="border-b border-slate-100 dark:border-slate-700">
                                                    <td class="py-3 text-slate-800 dark:text-slate-200 font-medium">${name}</td>
                                                    <td class="text-center py-3 text-slate-600 dark:text-slate-400">${stats.total}</td>
                                                    <td class="text-center py-3">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                                            ${stats.published}
                                                        </span>
                                                    </td>
                                                    <td class="text-center py-3">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200">
                                                            ${stats.draft}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Category Distribution Table -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Category Distribution</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-slate-200 dark:border-slate-700">
                                            <th class="text-left py-2 text-slate-600 dark:text-slate-400">Category</th>
                                            <th class="text-center py-2 text-slate-600 dark:text-slate-400">Articles</th>
                                            <th class="text-center py-2 text-slate-600 dark:text-slate-400">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(analytics.articlesByCategory)
                                            .sort(([,a], [,b]) => b - a)
                                            .map(([name, count]) => {
                                                const percentage = analytics.overview.totalArticles > 0
                                                    ? Math.round((count / analytics.overview.totalArticles) * 100)
                                                    : 0;
                                                return `
                                                    <tr class="border-b border-slate-100 dark:border-slate-700">
                                                        <td class="py-3 text-slate-800 dark:text-slate-200 font-medium">${name}</td>
                                                        <td class="text-center py-3 text-slate-600 dark:text-slate-400">${count}</td>
                                                        <td class="text-center py-3">
                                                            <div class="flex items-center justify-center space-x-2">
                                                                <div class="w-12 bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                                                </div>
                                                                <span class="text-xs text-slate-600 dark:text-slate-400">${percentage}%</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 mb-8">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Recent Activity</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${analytics.overview.recentArticles}</div>
                                <div class="text-sm text-slate-600 dark:text-slate-400">Articles this week</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400">${analytics.overview.recentGalleryItems}</div>
                                <div class="text-sm text-slate-600 dark:text-slate-400">Gallery items this week</div>
                            </div>
                            <div class="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${analytics.overview.publishingRate}%</div>
                                <div class="text-sm text-slate-600 dark:text-slate-400">Publishing rate</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <button onclick="adminDashboard.showSection('articles')" class="flex flex-col items-center p-4 bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg transition-colors btn-primary">
                                <svg class="w-8 h-8 text-yellow-600 dark:text-yellow-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">New Article</span>
                            </button>
                            <button onclick="adminDashboard.showSection('authors')" class="flex flex-col items-center p-4 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors btn-primary">
                                <svg class="w-8 h-8 text-blue-600 dark:text-blue-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Manage Authors</span>
                            </button>
                            <button onclick="adminDashboard.showSection('categories')" class="flex flex-col items-center p-4 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded-lg transition-colors btn-primary">
                                <svg class="w-8 h-8 text-purple-600 dark:text-purple-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Manage Categories</span>
                            </button>
                            <button onclick="adminDashboard.showSection('gallery')" class="flex flex-col items-center p-4 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors btn-primary">
                                <svg class="w-8 h-8 text-green-600 dark:text-green-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Manage Gallery</span>
                            </button>
                        </div>
                    </div>
                `;

                // Initialize charts after DOM is updated
                setTimeout(() => {
                    this.initializeAnalyticsCharts(analytics);
                }, 100);
            }

            initializeAnalyticsCharts(analytics) {
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#e2e8f0' : '#334155';
                const gridColor = isDark ? '#475569' : '#e2e8f0';

                // Destroy existing charts if they exist
                if (window.analyticsCharts) {
                    Object.values(window.analyticsCharts).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            chart.destroy();
                        }
                    });
                }
                window.analyticsCharts = {};

                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded');
                    return;
                }

                // Articles by Status - Doughnut Chart
                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    window.analyticsCharts.status = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Published', 'Draft', 'Archived'],
                            datasets: [{
                                data: [
                                    analytics.overview.publishedArticles,
                                    analytics.overview.draftArticles,
                                    analytics.overview.archivedArticles
                                ],
                                backgroundColor: [
                                    '#10B981', // Green for published
                                    '#F59E0B', // Orange for draft
                                    '#6B7280'  // Gray for archived
                                ],
                                borderWidth: 2,
                                borderColor: isDark ? '#1e293b' : '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: textColor,
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }

                // Monthly Trends - Line Chart
                const trendsCtx = document.getElementById('trendsChart');
                if (trendsCtx) {
                    const months = Object.keys(analytics.monthlyTrends);
                    const values = Object.values(analytics.monthlyTrends);

                    // Ensure we have at least some data points
                    if (months.length === 0) {
                        const now = new Date();
                        for (let i = 5; i >= 0; i--) {
                            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                            const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            months.push(monthKey);
                            values.push(0);
                        }
                    }

                    window.analyticsCharts.trends = new Chart(trendsCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Articles Published',
                                data: values,
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#3B82F6',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: textColor,
                                        stepSize: 1
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                }
                            }
                        }
                    });
                }

                // Articles by Category - Bar Chart
                const categoryCtx = document.getElementById('categoryChart');
                if (categoryCtx) {
                    const categoryNames = Object.keys(analytics.articlesByCategory);
                    const categoryValues = Object.values(analytics.articlesByCategory);

                    // Handle empty data
                    if (categoryNames.length === 0) {
                        categoryNames.push('No Categories');
                        categoryValues.push(0);
                    }

                    window.analyticsCharts.category = new Chart(categoryCtx, {
                        type: 'bar',
                        data: {
                            labels: categoryNames,
                            datasets: [{
                                label: 'Articles',
                                data: categoryValues,
                                backgroundColor: [
                                    '#8B5CF6', '#06B6D4', '#10B981', '#F59E0B', '#EF4444', '#6366F1'
                                ],
                                borderRadius: 8,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: textColor,
                                        stepSize: 1
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }

                // Author Productivity - Horizontal Bar Chart
                const authorCtx = document.getElementById('authorChart');
                if (authorCtx) {
                    const authorNames = Object.keys(analytics.articlesByAuthor);
                    const authorValues = authorNames.map(name => analytics.articlesByAuthor[name].total);

                    // Handle empty data
                    if (authorNames.length === 0) {
                        authorNames.push('No Authors');
                        authorValues.push(0);
                    }

                    window.analyticsCharts.author = new Chart(authorCtx, {
                        type: 'bar',
                        data: {
                            labels: authorNames,
                            datasets: [{
                                label: 'Total Articles',
                                data: authorValues,
                                backgroundColor: '#F59E0B',
                                borderRadius: 8,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: textColor,
                                        stepSize: 1
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            }

            exportAnalytics() {
                if (!this.lastAnalyticsData) {
                    this.showToast('No analytics data to export', 'error');
                    return;
                }

                try {
                    const exportData = {
                        generatedAt: new Date().toISOString(),
                        overview: this.lastAnalyticsData.overview,
                        articlesByCategory: this.lastAnalyticsData.articlesByCategory,
                        articlesByAuthor: this.lastAnalyticsData.articlesByAuthor,
                        monthlyTrends: this.lastAnalyticsData.monthlyTrends,
                        galleryByCategory: this.lastAnalyticsData.galleryByCategory
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `onward-dominicans-analytics-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    this.showToast('Analytics data exported successfully!', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showToast('Failed to export analytics data', 'error');
                }
            }

            async loadSettings() {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `
                    <div class="text-center py-12">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-4">System Settings</h2>
                        <p class="text-slate-600 dark:text-slate-400">Settings feature coming soon!</p>
                    </div>
                `;
            }

            async loadGallery() {
                try {
                    console.log('🖼️ Loading gallery data from backend...');
                    console.log('🔍 DEBUG: Current gallery items count before load:', this.galleryItems?.length || 0);
                    console.log('🔍 DEBUG: Current gallery categories count before load:', this.galleryCategories?.length || 0);

                    // Load gallery data with cache busting
                    const timestamp = Date.now();
                    console.log('🔍 DEBUG: Making API calls with timestamp:', timestamp);

                    const [galleryResponse, galleryCategoriesResponse] = await Promise.all([
                        this.makeAPICall(`/gallery?limit=50&_t=${timestamp}`),
                        this.makeAPICall(`/gallery-categories?limit=50&_t=${timestamp}`)
                    ]);

                    console.log('🖼️ Gallery response:', galleryResponse);
                    console.log('🏷️ Gallery categories response:', galleryCategoriesResponse);
                    console.log('🔍 DEBUG: Gallery response success:', galleryResponse?.success);
                    console.log('🔍 DEBUG: Categories response success:', galleryCategoriesResponse?.success);

                    this.galleryItems = galleryResponse.data || [];
                    this.galleryCategories = galleryCategoriesResponse.data || [];

                    console.log(`✅ Loaded ${this.galleryItems.length} gallery items and ${this.galleryCategories.length} categories from backend`);

                    // Update gallery count in sidebar
                    document.getElementById('gallery-count').textContent = galleryResponse.meta?.total || 0;

                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = `
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200">Gallery Management</h2>
                                <p class="text-slate-600 dark:text-slate-400 mt-2">Manage your photo gallery and categories.</p>
                                <div class="mt-2 text-sm text-green-600 dark:text-green-400">
                                    ✅ Data loaded from backend API (${this.galleryItems.length} items, ${this.galleryCategories.length} categories)
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="adminDashboard.createGalleryCategory()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg btn-primary flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span>New Category</span>
                                </button>
                                <button onclick="adminDashboard.createMultiImageEvent()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg btn-primary flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <span>Multi-Image Event</span>
                                </button>
                                <button onclick="adminDashboard.createSingleImage()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg btn-primary flex items-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span>Add Single Image</span>
                                </button>
                            </div>
                        </div>

                        <!-- Gallery Categories Section -->
                        <div class="mb-8">
                            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg admin-card">
                                <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                                    <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200">Gallery Categories (${this.galleryCategories.length})</h3>
                                </div>
                                <div class="p-6">
                                    ${this.galleryCategories.length > 0 ? `
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            ${this.galleryCategories.map(category => `
                                                <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-6 border border-slate-200 dark:border-slate-600">
                                                    <div class="flex items-center space-x-3 mb-4">
                                                        <div class="w-6 h-6 rounded-full flex-shrink-0" style="background-color: ${category.color}"></div>
                                                        <div class="flex-1 min-w-0">
                                                            <h4 class="text-lg font-medium text-slate-900 dark:text-slate-100 truncate">${category.name}</h4>
                                                            <p class="text-sm text-slate-500 dark:text-slate-400 truncate">/${category.slug}</p>
                                                        </div>
                                                    </div>
                                                    ${category.description ? `<p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${category.description}</p>` : ''}
                                                    <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                                                        <span>${category._count?.galleryItems || 0} items</span>
                                                        <div class="flex space-x-2">
                                                            <button onclick="adminDashboard.editGalleryCategory('${category.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">Edit</button>
                                                            <button onclick="adminDashboard.deleteGalleryCategory('${category.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400">Delete</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="text-center py-8">
                                            <div class="text-slate-400 dark:text-slate-500 text-4xl mb-4">🏷️</div>
                                            <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100 mb-2">No gallery categories yet</h3>
                                            <p class="text-slate-500 dark:text-slate-400 mb-4">Create categories to organize your gallery items</p>
                                            <button onclick="adminDashboard.createGalleryCategory()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">Create First Category</button>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <!-- Gallery Stacks Section -->
                        <div class="mb-8">
                            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg admin-card">
                                <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                                    <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200">Image Stacks</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Grouped images for events and topics</p>
                                </div>
                                <div class="p-6">
                                    ${(() => {
                                        // Get unique stack groups
                                        const stackGroups = new Set();
                                        this.galleryItems.forEach(item => {
                                            if (item.stackGroup) {
                                                stackGroups.add(item.stackGroup);
                                            }
                                        });

                                        if (stackGroups.size > 0) {
                                            const sortedStacks = Array.from(stackGroups).sort();
                                            return `
                                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    ${sortedStacks.map(stackGroup => {
                                                        const stackItems = this.galleryItems.filter(item => item.stackGroup === stackGroup);
                                                        const coverImage = stackItems.find(item => item.isStackCover) || stackItems[0];
                                                        return `
                                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-4 border border-slate-200 dark:border-slate-600">
                                                                <div class="flex items-center space-x-3 mb-3">
                                                                    <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0">
                                                                        <img src="${coverImage.thumbnailUrl || coverImage.imageUrl}" alt="${stackGroup}" class="w-full h-full object-cover">
                                                                    </div>
                                                                    <div class="flex-1 min-w-0">
                                                                        <h4 class="text-sm font-medium text-slate-900 dark:text-slate-100 truncate">${stackGroup}</h4>
                                                                        <p class="text-xs text-slate-500 dark:text-slate-400">${stackItems.length} images</p>
                                                                    </div>
                                                                </div>
                                                                <div class="text-xs text-slate-600 dark:text-slate-400">
                                                                    <p>Cover: ${coverImage.title}</p>
                                                                    <p>Created: ${new Date(Math.min(...stackItems.map(item => new Date(item.createdAt)))).toLocaleDateString()}</p>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            `;
                                        } else {
                                            return `
                                                <div class="text-center py-8">
                                                    <div class="text-slate-400 dark:text-slate-500 text-4xl mb-4">📚</div>
                                                    <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100 mb-2">No image stacks yet</h3>
                                                    <p class="text-slate-500 dark:text-slate-400 mb-4">Create stacks by grouping multiple images for the same event</p>
                                                    <button onclick="adminDashboard.createMultiImageEvent()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Add Images to Create Stack</button>
                                                </div>
                                            `;
                                        }
                                    })()}
                                </div>
                            </div>
                        </div>

                        <!-- Gallery Items Section -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg admin-card">
                            <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                                <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-200">Gallery Items (${this.galleryItems.length})</h3>
                            </div>
                            <div class="p-6">
                                ${this.galleryItems.length > 0 ? `
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        ${this.galleryItems.map(item => `
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg overflow-hidden border border-slate-200 dark:border-slate-600 ${item.stackGroup ? 'ring-2 ring-blue-200 dark:ring-blue-800' : ''}">
                                                <div class="aspect-w-16 aspect-h-12 relative">
                                                    <img src="${item.thumbnailUrl || item.imageUrl}" alt="${item.title}" class="w-full h-48 object-cover">
                                                    ${item.stackGroup ? `
                                                        <div class="absolute top-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full flex items-center space-x-1">
                                                            <span>📚</span>
                                                            <span>${this.galleryItems.filter(i => i.stackGroup === item.stackGroup).length}</span>
                                                        </div>
                                                    ` : ''}
                                                    ${item.isStackCover ? `
                                                        <div class="absolute top-2 right-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">
                                                            ⭐ Cover
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                <div class="p-4">
                                                    <h4 class="text-sm font-medium text-slate-900 dark:text-slate-100 truncate mb-2">${item.title}</h4>
                                                    ${item.category ? `
                                                        <div class="flex items-center mb-2">
                                                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${item.category.color}"></div>
                                                            <span class="text-xs text-slate-500 dark:text-slate-400">${item.category.name}</span>
                                                        </div>
                                                    ` : ''}
                                                    ${item.stackGroup ? `<p class="text-xs text-blue-600 dark:text-blue-400 mb-2">📚 Stack: ${item.stackGroup} (${item.stackOrder})</p>` : ''}
                                                    <div class="text-xs text-slate-500 dark:text-slate-400 space-y-1">
                                                        ${item.photographer ? `<p>📸 ${item.photographer}</p>` : ''}
                                                        ${item.location ? `<p>📍 ${item.location}</p>` : ''}
                                                        <p>📅 ${new Date(item.createdAt).toLocaleDateString()}</p>
                                                    </div>
                                                    <div class="mt-3 flex space-x-2">
                                                        <button onclick="adminDashboard.editGalleryItem('${item.id}')" class="flex-1 text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-300">Edit</button>
                                                        <button onclick="adminDashboard.deleteGalleryItem('${item.id}')" class="flex-1 text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 dark:bg-red-900 dark:text-red-300">Delete</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-12">
                                        <div class="text-slate-400 dark:text-slate-500 text-6xl mb-4">🖼️</div>
                                        <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100 mb-2">No gallery items yet</h3>
                                        <p class="text-slate-500 dark:text-slate-400 mb-6">Get started by adding your first image to the gallery</p>
                                        <button onclick="adminDashboard.createSingleImage()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg">Add Your First Image</button>
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading gallery:', error);
                    this.showToast('Error loading gallery data', 'error');
                }
            }

            setupArticleEditor() {
                // Image URL preview
                const imageInput = document.getElementById('article-image');
                if (imageInput) {
                    imageInput.addEventListener('input', (e) => {
                        this.updateImagePreview(e.target.value);
                    });
                }

                // Close modal when clicking outside
                const modal = document.getElementById('article-editor-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeArticleEditor();
                        }
                    });
                }

                // Enhanced content editor initialization
                const contentEditor = document.getElementById('article-content');
                const htmlEditor = document.getElementById('article-content-html');

                if (contentEditor) {
                    // Keyboard shortcuts
                    contentEditor.addEventListener('keydown', (e) => {
                        // Handle common keyboard shortcuts
                        if (e.ctrlKey || e.metaKey) {
                            switch (e.key.toLowerCase()) {
                                case 'b':
                                    e.preventDefault();
                                    this.formatText('bold');
                                    break;
                                case 'i':
                                    e.preventDefault();
                                    this.formatText('italic');
                                    break;
                                case 'u':
                                    e.preventDefault();
                                    this.formatText('underline');
                                    break;
                                case 'z':
                                    if (e.shiftKey) {
                                        e.preventDefault();
                                        this.formatText('redo');
                                    } else {
                                        e.preventDefault();
                                        this.formatText('undo');
                                    }
                                    break;
                                case 'y':
                                    e.preventDefault();
                                    this.formatText('redo');
                                    break;
                                case 'k':
                                    e.preventDefault();
                                    this.insertLink();
                                    break;
                            }
                        }

                        // Handle Enter key for better paragraph formatting
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            document.execCommand('insertHTML', false, '<br><br>');
                        }
                    });

                    // Real-time content updates
                    contentEditor.addEventListener('input', () => {
                        this.updateEditorStats();
                        this.handleAutoSave();
                    });

                    // Paste handling for better formatting
                    contentEditor.addEventListener('paste', (e) => {
                        e.preventDefault();
                        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                        document.execCommand('insertHTML', false, text.replace(/\n/g, '<br>'));
                        this.updateEditorStats();
                    });

                    // Initialize editor stats
                    this.updateEditorStats();
                }

                // HTML editor synchronization
                if (htmlEditor) {
                    htmlEditor.addEventListener('input', () => {
                        // Update visual editor when HTML changes
                        if (contentEditor.style.display === 'none') {
                            // We're in HTML mode, update will happen when switching back
                        }
                    });
                }

                // Initialize heading selector
                const headingSelect = document.querySelector('.editor-select');
                if (headingSelect) {
                    headingSelect.addEventListener('change', (e) => {
                        this.formatHeading(e.target.value);
                        e.target.value = ''; // Reset selector
                    });
                }

                // Form validation
                const form = document.getElementById('article-editor-form');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveArticle();
                    });
                }
            }

            setupAuthorEditor() {
                // Avatar URL preview
                const avatarInput = document.getElementById('author-avatar');
                if (avatarInput) {
                    avatarInput.addEventListener('input', (e) => {
                        this.updateAvatarPreview(e.target.value);
                    });
                }

                // Bio character count
                const bioInput = document.getElementById('author-bio');
                if (bioInput) {
                    bioInput.addEventListener('input', () => {
                        this.updateBioCharCount();
                    });
                    // Initialize character count
                    this.updateBioCharCount();
                }

                // Email validation on blur
                const emailInput = document.getElementById('author-email');
                if (emailInput) {
                    emailInput.addEventListener('blur', (e) => {
                        const email = e.target.value.trim();
                        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                            e.target.style.borderColor = '#ef4444';
                            this.showToast('Please enter a valid email address', 'warning');
                        } else {
                            e.target.style.borderColor = '';
                        }
                    });
                }

                // Close modal when clicking outside
                const modal = document.getElementById('author-editor-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeAuthorEditor();
                        }
                    });
                }

                // Form validation
                const form = document.getElementById('author-editor-form');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveAuthor();
                    });
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                        this.closeAuthorEditor();
                    }
                });
            }

            setupGalleryEditors() {
                // Setup image input listeners for the initial image
                this.setupImageInputListeners();

                // Gallery category color picker sync
                const colorPicker = document.getElementById('gallery-category-color');
                const colorText = document.getElementById('gallery-category-color-text');
                if (colorPicker && colorText) {
                    colorPicker.addEventListener('input', (e) => {
                        colorText.value = e.target.value;
                    });
                    colorText.addEventListener('input', (e) => {
                        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                            colorPicker.value = e.target.value;
                        }
                    });
                }

                // Close modals when clicking outside
                const galleryModal = document.getElementById('gallery-editor-modal');
                if (galleryModal) {
                    galleryModal.addEventListener('click', (e) => {
                        if (e.target === galleryModal) {
                            this.closeGalleryEditor();
                        }
                    });
                }

                const galleryCategoryModal = document.getElementById('gallery-category-editor-modal');
                if (galleryCategoryModal) {
                    galleryCategoryModal.addEventListener('click', (e) => {
                        if (e.target === galleryCategoryModal) {
                            this.closeGalleryCategoryEditor();
                        }
                    });
                }

                // Form validation
                const galleryForm = document.getElementById('gallery-editor-form');
                if (galleryForm) {
                    galleryForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveGalleryItem();
                    });
                }

                const galleryCategoryForm = document.getElementById('gallery-category-editor-form');
                if (galleryCategoryForm) {
                    galleryCategoryForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveGalleryCategory();
                    });
                }
            }

            // Gallery Item Management Methods
            async createSingleImage() {
                console.log('📸 Opening single image creation modal...');
                this.currentEditingGalleryItem = null;
                this.openGalleryEditor('single');
            }

            async createMultiImageEvent() {
                console.log('📚 Opening multi-image event creation modal...');
                this.currentEditingGalleryItem = null;
                this.openGalleryEditor('multi');
            }

            // Legacy function for backward compatibility
            async createGalleryItem() {
                console.log('🆕 Opening gallery item creation modal (legacy)...');
                this.currentEditingGalleryItem = null;
                this.openGalleryEditor('multi');
            }



            async editGalleryItem(itemId) {
                console.log('✏️ Opening gallery item edit modal for:', itemId);
                const item = this.galleryItems.find(i => i.id === itemId);
                if (item) {
                    this.currentEditingGalleryItem = item;
                    this.openGalleryEditor(item);
                } else {
                    this.showToast('Gallery item not found', 'error');
                }
            }

            async deleteGalleryItem(itemId) {
                if (!confirm('Are you sure you want to delete this gallery item?')) return;

                try {
                    const response = await this.makeAPICall(`/gallery/${itemId}`, 'DELETE');
                    if (response.success) {
                        this.showToast('Gallery item deleted successfully', 'success');
                        this.loadGallery(); // Refresh the gallery
                    } else {
                        this.showToast('Failed to delete gallery item', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting gallery item:', error);
                    this.showToast('Error deleting gallery item', 'error');
                }
            }

            openGalleryEditor(mode = 'multi', item = null) {
                const modal = document.getElementById('gallery-editor-modal');
                const title = document.getElementById('gallery-editor-modal-title');
                const form = document.getElementById('gallery-editor-form');

                // Set modal title based on mode
                if (item) {
                    title.textContent = 'Edit Gallery Item';
                } else if (mode === 'single') {
                    title.textContent = 'Add Single Image';
                } else {
                    title.textContent = 'Add Multi-Image Event';
                }

                // Load categories
                this.loadGalleryEditorData();

                // Populate form if editing
                if (item) {
                    this.populateGalleryForm(item);
                } else {
                    form.reset();
                    this.resetImageInputs(mode);
                }

                // Show modal
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Focus on title field
                setTimeout(() => {
                    document.getElementById('gallery-title').focus();
                }, 100);
            }

            closeGalleryEditor() {
                const modal = document.getElementById('gallery-editor-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
                this.currentEditingGalleryItem = null;
            }

            loadGalleryEditorData() {
                console.log('🔍 DEBUG: Loading gallery editor data...');

                // Populate category dropdown
                const categorySelect = document.getElementById('gallery-category');
                if (!categorySelect) {
                    console.error('🔍 DEBUG: Category select element not found!');
                    return;
                }

                categorySelect.innerHTML = '<option value="">Select a category</option>';

                console.log('🔍 DEBUG: Available gallery categories:', this.galleryCategories?.length || 0);

                if (!this.galleryCategories || this.galleryCategories.length === 0) {
                    console.warn('🔍 DEBUG: No gallery categories available!');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No categories available - Create one first';
                    option.disabled = true;
                    categorySelect.appendChild(option);
                    return;
                }

                this.galleryCategories.forEach(category => {
                    console.log('🔍 DEBUG: Adding category option:', category.name, category.id);
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });

                console.log('🔍 DEBUG: Category dropdown populated with', categorySelect.options.length - 1, 'categories');
            }



            resetImageInputs(mode = 'multi') {
                const container = document.getElementById('images-container');
                const addButton = document.getElementById('add-image-btn');

                // Remove all but the first image input
                const groups = container.querySelectorAll('.image-input-group');
                for (let i = 1; i < groups.length; i++) {
                    groups[i].remove();
                }

                // Reset the first image input
                const firstGroup = container.querySelector('.image-input-group');
                const inputs = firstGroup.querySelectorAll('input');
                inputs.forEach(input => input.value = '');

                // Hide preview
                const preview = firstGroup.querySelector('.image-preview');
                preview.classList.add('hidden');

                // Update first group title based on mode
                const firstGroupTitle = firstGroup.querySelector('h4');
                if (mode === 'single') {
                    firstGroupTitle.textContent = '📸 Image';
                    // Hide the "Add Another Image" button for single image mode
                    addButton.style.display = 'none';
                    // Update the button text and description
                    const buttonText = addButton.parentElement.querySelector('span:last-child');
                    if (buttonText) buttonText.textContent = 'Single image only';
                } else {
                    firstGroupTitle.textContent = '📸 Main Image (Cover)';
                    // Show the "Add Another Image" button for multi-image mode
                    addButton.style.display = 'flex';
                }

                // Setup listeners
                this.setupImageInputListeners();
            }

            populateGalleryForm(item) {
                document.getElementById('gallery-title').value = item.title || '';
                document.getElementById('gallery-description').value = item.description || '';
                document.getElementById('gallery-category').value = item.categoryId || '';
                document.getElementById('gallery-photographer').value = item.photographer || '';
                document.getElementById('gallery-location').value = item.location || '';

                if (item.dateTaken) {
                    const date = new Date(item.dateTaken);
                    document.getElementById('gallery-date-taken').value = date.toISOString().split('T')[0];
                }

                // Reset image inputs first
                this.resetImageInputs();

                // Populate the first image input
                const firstGroup = document.getElementById('images-container').querySelector('.image-input-group');
                const imageInput = firstGroup.querySelector('input[name="imageUrl"]');
                const thumbnailInput = firstGroup.querySelector('input[name="thumbnailUrl"]');

                imageInput.value = item.imageUrl || '';
                thumbnailInput.value = item.thumbnailUrl || '';

                // Show image preview if URL exists
                if (item.imageUrl) {
                    this.updateGalleryImagePreview(imageInput, 0);
                }

                // If this item is part of a stack, load other stack images
                if (item.stackGroup) {
                    this.loadStackImages(item.stackGroup, item.id);
                }
            }

            async loadStackImages(stackGroup, currentItemId) {
                try {
                    // Get all items in this stack
                    const stackItems = this.galleryItems.filter(item =>
                        item.stackGroup === stackGroup && item.id !== currentItemId
                    ).sort((a, b) => (a.stackOrder || 0) - (b.stackOrder || 0));

                    // Add additional image inputs for stack items
                    for (const stackItem of stackItems) {
                        this.addImageInput();

                        // Get the last added image group
                        const container = document.getElementById('images-container');
                        const lastGroup = container.lastElementChild;
                        const imageInput = lastGroup.querySelector('input[name="imageUrl"]');
                        const thumbnailInput = lastGroup.querySelector('input[name="thumbnailUrl"]');

                        imageInput.value = stackItem.imageUrl || '';
                        thumbnailInput.value = stackItem.thumbnailUrl || '';

                        if (stackItem.imageUrl) {
                            const index = container.children.length - 1;
                            this.updateGalleryImagePreview(imageInput, index);
                        }
                    }
                } catch (error) {
                    console.error('Error loading stack images:', error);
                }
            }

            setupImageInputListeners() {
                // Setup listeners for all existing image inputs
                const imageInputs = document.querySelectorAll('.image-input-group input[name="imageUrl"]');
                imageInputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                        this.updateGalleryImagePreview(e.target, index);
                    });
                });
            }

            updateGalleryImagePreview(input, index) {
                const group = input.closest('.image-input-group');
                const preview = group.querySelector('.image-preview');
                const img = preview.querySelector('img');

                if (input.value && input.value.trim()) {
                    img.src = input.value;
                    preview.classList.remove('hidden');
                } else {
                    preview.classList.add('hidden');
                }
            }

            addImageInput() {
                const container = document.getElementById('images-container');
                const currentCount = container.children.length;

                if (currentCount >= 5) {
                    this.showToast('Maximum 5 images allowed per event', 'warning');
                    return;
                }

                const newIndex = currentCount;
                const imageGroup = document.createElement('div');
                imageGroup.className = 'image-input-group border border-slate-300 dark:border-slate-600 rounded-lg p-4 bg-slate-50 dark:bg-slate-700';
                imageGroup.setAttribute('data-index', newIndex);

                imageGroup.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-medium text-slate-800 dark:text-slate-200">📸 Image ${newIndex + 1}</h4>
                        <button type="button" onclick="adminDashboard.removeImageInput(${newIndex})"
                            class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Image URL *</label>
                            <input type="url" name="imageUrl" required
                                class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm"
                                placeholder="https://example.com/image${newIndex + 1}.jpg">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Thumbnail URL (optional)</label>
                            <input type="url" name="thumbnailUrl"
                                class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm"
                                placeholder="https://example.com/thumb${newIndex + 1}.jpg">
                        </div>
                        <div class="image-preview hidden">
                            <img src="" alt="Preview" class="w-full h-32 object-cover rounded-md border border-slate-200 dark:border-slate-600">
                        </div>
                    </div>
                `;

                container.appendChild(imageGroup);

                // Setup listener for the new input
                const newInput = imageGroup.querySelector('input[name="imageUrl"]');
                newInput.addEventListener('input', (e) => {
                    this.updateGalleryImagePreview(e.target, newIndex);
                });

                // Update button state
                if (currentCount + 1 >= 5) {
                    document.getElementById('add-image-btn').style.display = 'none';
                }

                this.showToast(`Image ${newIndex + 1} input added`, 'success');
            }

            removeImageInput(index) {
                const container = document.getElementById('images-container');
                const group = container.querySelector(`[data-index="${index}"]`);

                if (group && index > 0) { // Don't allow removing the main image
                    group.remove();

                    // Re-index remaining groups
                    const remainingGroups = container.querySelectorAll('.image-input-group');
                    remainingGroups.forEach((group, newIndex) => {
                        group.setAttribute('data-index', newIndex);
                        const title = group.querySelector('h4');
                        if (newIndex === 0) {
                            title.textContent = '📸 Main Image (Cover)';
                            // Remove delete button from main image
                            const deleteBtn = group.querySelector('button');
                            if (deleteBtn) deleteBtn.remove();
                        } else {
                            title.textContent = `📸 Image ${newIndex + 1}`;
                            // Update delete button onclick
                            const deleteBtn = group.querySelector('button');
                            if (deleteBtn) {
                                deleteBtn.setAttribute('onclick', `adminDashboard.removeImageInput(${newIndex})`);
                            }
                        }
                    });

                    // Show add button if under limit
                    if (remainingGroups.length < 5) {
                        document.getElementById('add-image-btn').style.display = 'flex';
                    }

                    this.showToast('Image input removed', 'success');
                }
            }

            async saveGalleryItem() {
                console.log('🚀 Starting saveGalleryItem function...');
                console.log('🔍 DEBUG: Current user ID being used:', 'cmbsufok100009durfa1z503t');

                const form = document.getElementById('gallery-editor-form');
                const formData = new FormData(form);
                const saveBtn = document.getElementById('gallery-save-btn-text');
                const saveSpinner = document.getElementById('gallery-save-spinner');
                const saveStatus = document.getElementById('gallery-save-status');

                // Debug form data
                console.log('🔍 DEBUG: Form element found:', !!form);
                console.log('🔍 DEBUG: FormData entries:');
                for (let [key, value] of formData.entries()) {
                    console.log(`  ${key}: ${value}`);
                }

                // Validate required fields
                const title = formData.get('title')?.trim();
                const categoryId = formData.get('categoryId');

                if (!title) {
                    this.showToast('Please enter a title for the gallery item', 'error');
                    return;
                }

                if (title.length < 3) {
                    this.showToast('Title must be at least 3 characters long', 'error');
                    return;
                }

                if (!categoryId) {
                    this.showToast('Please select a category', 'error');
                    return;
                }

                // Get all image inputs with detailed logging
                const imageGroups = document.querySelectorAll('.image-input-group');
                console.log(`📸 Found ${imageGroups.length} image input groups`);

                const images = [];

                // Validate and collect image data
                for (let i = 0; i < imageGroups.length; i++) {
                    const group = imageGroups[i];
                    console.log(`🔍 Processing image group ${i + 1}:`, group);

                    const imageUrlInput = group.querySelector('input[name="imageUrl"]');
                    const thumbnailUrlInput = group.querySelector('input[name="thumbnailUrl"]');

                    if (!imageUrlInput) {
                        console.error(`❌ No imageUrl input found in group ${i + 1}`);
                        this.showToast(`Image URL input not found for Image ${i + 1}`, 'error');
                        return;
                    }

                    const imageUrl = imageUrlInput.value.trim();
                    const thumbnailUrl = thumbnailUrlInput ? thumbnailUrlInput.value.trim() : '';

                    console.log(`📝 Image ${i + 1} data:`, { imageUrl, thumbnailUrl });

                    if (!imageUrl) {
                        this.showToast(`Please provide URL for Image ${i + 1}`, 'error');
                        return;
                    }

                    // Validate image URL format
                    if (!this.isValidUrl(imageUrl)) {
                        this.showToast(`Please provide a valid URL for Image ${i + 1}`, 'error');
                        return;
                    }

                    // Validate thumbnail URL if provided
                    if (thumbnailUrl && !this.isValidUrl(thumbnailUrl)) {
                        this.showToast(`Please provide a valid thumbnail URL for Image ${i + 1}`, 'error');
                        return;
                    }

                    images.push({
                        imageUrl,
                        thumbnailUrl: thumbnailUrl && thumbnailUrl.trim() !== '' ? thumbnailUrl.trim() : null,
                        isMain: i === 0 // First image is the main/cover image
                    });
                }

                console.log(`✅ Collected ${images.length} valid images:`, images);

                if (images.length === 0) {
                    this.showToast('Please add at least one image', 'error');
                    return;
                }

                try {
                    saveBtn.textContent = 'Saving...';
                    saveSpinner.classList.remove('hidden');
                    saveStatus.textContent = `Saving ${images.length} image(s)...`;

                    // Create stack group name from title if multiple images
                    let stackGroup = null;
                    if (images.length > 1) {
                        stackGroup = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-') + '-' + Date.now();
                        console.log(`📚 Creating stack group: ${stackGroup}`);
                    } else {
                        console.log('📸 Single image - no stack group needed');
                    }

                    // Helper function to convert empty strings to null
                    const getFormValue = (key) => {
                        const value = formData.get(key);
                        return (value && value.trim() !== '') ? value.trim() : null;
                    };

                    // Helper function to format date for backend
                    const getDateValue = (key) => {
                        const value = getFormValue(key);
                        if (!value) return null;

                        try {
                            // If it's already a valid date string, convert to ISO format
                            const date = new Date(value);
                            if (isNaN(date.getTime())) return null;
                            return date.toISOString();
                        } catch (error) {
                            console.warn(`Invalid date format for ${key}:`, value);
                            return null;
                        }
                    };

                    const baseData = {
                        categoryId: getFormValue('categoryId'),
                        photographer: getFormValue('photographer'),
                        location: getFormValue('location'),
                        dateTaken: getDateValue('dateTaken')
                    };

                    console.log('📋 Base form data:', baseData);

                    // If editing existing item, update it
                    if (this.currentEditingGalleryItem) {
                        const itemData = {
                            ...baseData,
                            title: title.trim(),
                            description: getFormValue('description'),
                            imageUrl: images[0].imageUrl,
                            thumbnailUrl: images[0].thumbnailUrl,
                            stackGroup: images.length > 1 ? stackGroup : null,
                            stackOrder: 1,
                            isStackCover: true
                        };

                        console.log('📤 Sending gallery item update data:', itemData);
                        const response = await this.makeAPICall(`/gallery/${this.currentEditingGalleryItem.id}`, 'PUT', itemData);
                        if (response.success) {
                            this.showToast('Gallery item updated successfully!', 'success');
                            this.closeGalleryEditor();
                            this.loadGallery();
                        } else {
                            const errorMsg = response.error?.message || 'Failed to update gallery item';
                            this.showToast(errorMsg, 'error');
                        }
                        return;
                    }

                    // Create new items
                    console.log(`🔄 Starting to create ${images.length} gallery items...`);
                    const createdItems = [];

                    for (let i = 0; i < images.length; i++) {
                        const image = images[i];
                        const itemData = {
                            ...baseData,
                            title: i === 0 ? title.trim() : `${title.trim()} - Image ${i + 1}`,
                            description: i === 0 ? getFormValue('description') : null,
                            imageUrl: image.imageUrl,
                            thumbnailUrl: image.thumbnailUrl,
                            stackGroup: stackGroup,
                            stackOrder: i + 1,
                            isStackCover: i === 0 // First image is cover
                        };

                        saveStatus.textContent = `Saving image ${i + 1} of ${images.length}...`;
                        console.log(`📤 Sending gallery item data for image ${i + 1}:`, itemData);

                        try {
                            const response = await this.makeAPICall('/gallery', 'POST', itemData);
                            console.log(`📥 Response for image ${i + 1}:`, response);

                            if (response.success) {
                                createdItems.push(response.data);
                                console.log(`✅ Successfully created image ${i + 1}`);
                            } else {
                                const errorMsg = response.error?.message || `Failed to save image ${i + 1}`;
                                this.showToast(errorMsg, 'error');
                                console.error(`❌ Error saving image ${i + 1}:`, response);
                                return;
                            }
                        } catch (apiError) {
                            console.error(`❌ API call failed for image ${i + 1}:`, apiError);
                            this.showToast(`API error saving image ${i + 1}: ${apiError.message}`, 'error');
                            return;
                        }
                    }

                    if (createdItems.length === images.length) {
                        const message = images.length === 1
                            ? 'Gallery item created successfully!'
                            : `Event created with ${images.length} images successfully!`;
                        this.showToast(message, 'success');
                        this.closeGalleryEditor();
                        this.loadGallery(); // Refresh the gallery
                    }

                } catch (error) {
                    console.error('Error saving gallery item:', error);
                    const errorMessage = error.message || 'Error saving gallery item';
                    this.showToast(`Error saving gallery item: ${errorMessage}`, 'error');
                } finally {
                    saveBtn.textContent = 'Save Event';
                    saveSpinner.classList.add('hidden');
                    saveStatus.textContent = '';
                }
            }

            // Gallery Category Management Methods
            async createGalleryCategory() {
                console.log('🆕 Opening gallery category creation modal...');
                this.currentEditingGalleryCategory = null;
                this.openGalleryCategoryEditor();
            }

            async editGalleryCategory(categoryId) {
                console.log('✏️ Opening gallery category edit modal for:', categoryId);
                const category = this.galleryCategories.find(c => c.id === categoryId);
                if (category) {
                    this.currentEditingGalleryCategory = category;
                    this.openGalleryCategoryEditor(category);
                } else {
                    this.showToast('Gallery category not found', 'error');
                }
            }

            async deleteGalleryCategory(categoryId) {
                if (!confirm('Are you sure you want to delete this gallery category?')) return;

                try {
                    const response = await this.makeAPICall(`/gallery-categories/${categoryId}`, 'DELETE');
                    if (response.success) {
                        this.showToast('Gallery category deleted successfully', 'success');
                        this.loadGallery(); // Refresh the gallery
                    } else {
                        this.showToast('Failed to delete gallery category', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting gallery category:', error);
                    this.showToast('Error deleting gallery category', 'error');
                }
            }

            openGalleryCategoryEditor(category = null) {
                const modal = document.getElementById('gallery-category-editor-modal');
                const title = document.getElementById('gallery-category-editor-modal-title');
                const form = document.getElementById('gallery-category-editor-form');

                // Set modal title
                title.textContent = category ? 'Edit Gallery Category' : 'Add Gallery Category';

                // Populate form if editing
                if (category) {
                    this.populateGalleryCategoryForm(category);
                } else {
                    form.reset();
                    document.getElementById('gallery-category-color').value = '#3B82F6';
                    document.getElementById('gallery-category-color-text').value = '#3B82F6';
                }

                // Show modal
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Focus on name field
                setTimeout(() => {
                    document.getElementById('gallery-category-name').focus();
                }, 100);
            }

            closeGalleryCategoryEditor() {
                const modal = document.getElementById('gallery-category-editor-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = '';
                this.currentEditingGalleryCategory = null;
            }

            populateGalleryCategoryForm(category) {
                document.getElementById('gallery-category-name').value = category.name || '';
                document.getElementById('gallery-category-description').value = category.description || '';
                document.getElementById('gallery-category-color').value = category.color || '#3B82F6';
                document.getElementById('gallery-category-color-text').value = category.color || '#3B82F6';
            }

            async saveGalleryCategory() {
                const form = document.getElementById('gallery-category-editor-form');
                const formData = new FormData(form);
                const saveBtn = document.getElementById('gallery-category-save-btn-text');
                const saveSpinner = document.getElementById('gallery-category-save-spinner');
                const saveStatus = document.getElementById('gallery-category-save-status');

                // Validate required fields
                const name = formData.get('name')?.trim();
                const color = formData.get('color')?.trim();

                if (!name) {
                    this.showToast('Please enter a category name', 'error');
                    return;
                }

                if (name.length < 2) {
                    this.showToast('Category name must be at least 2 characters long', 'error');
                    return;
                }

                // Validate color format
                const colorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
                if (color && !colorRegex.test(color)) {
                    this.showToast('Please enter a valid hex color code', 'error');
                    return;
                }

                try {
                    saveBtn.textContent = 'Saving...';
                    saveSpinner.classList.remove('hidden');
                    saveStatus.textContent = 'Saving gallery category...';

                    const categoryData = {
                        name: name,
                        description: formData.get('description')?.trim() || null,
                        color: color || '#3B82F6'
                    };

                    let response;
                    if (this.currentEditingGalleryCategory) {
                        // Update existing category
                        response = await this.makeAPICall(`/gallery-categories/${this.currentEditingGalleryCategory.id}`, 'PUT', categoryData);
                    } else {
                        // Create new category
                        response = await this.makeAPICall('/gallery-categories', 'POST', categoryData);
                    }

                    if (response.success) {
                        this.showToast(
                            this.currentEditingGalleryCategory ? 'Gallery category updated successfully!' : 'Gallery category created successfully!',
                            'success'
                        );
                        this.closeGalleryCategoryEditor();

                        // Refresh the gallery and update category dropdowns
                        this.loadGallery();
                        this.loadGalleryCategoryDropdown();
                    } else {
                        throw new Error(response.error?.message || 'Failed to save gallery category');
                    }
                } catch (error) {
                    console.error('Error saving gallery category:', error);
                    this.showToast('Error saving gallery category: ' + error.message, 'error');
                } finally {
                    saveBtn.textContent = 'Save Category';
                    saveSpinner.classList.add('hidden');
                    saveStatus.textContent = '';
                }
            }
        }

        
        // SSG Generation Function
        window.generateSSGPages = async function() {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<div class="spinner inline-block mr-2"></div>Generating...';
                button.disabled = true;
                
                // Call the SSG generation endpoint or script
                const response = await fetch('/api/generate-ssg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    adminDashboard.showToast('✅ Static pages generated successfully!', 'success');
                } else {
                    throw new Error('Generation failed');
                }
                
            } catch (error) {
                console.error('SSG Generation error:', error);
                adminDashboard.showToast('❌ Failed to generate static pages', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        };

        

        // Initialize the admin dashboard
        document.addEventListener('DOMContentLoaded', () => {
            window.adminDashboard = new AdminDashboard();

            // Expose debug functions to console
            window.debugGallery = () => window.adminDashboard.debugGallerySystem();
            window.testGalleryCreate = (testData) => {
                const defaultData = {
                    title: 'Test Gallery Item',
                    description: 'Test description',
                    imageUrl: 'https://via.placeholder.com/400x300',
                    categoryId: window.adminDashboard.galleryCategories?.[0]?.id || 'test-category',
                    photographer: 'Test Photographer',
                    location: 'Test Location',
                    dateTaken: new Date().toISOString()
                };
                return window.adminDashboard.createGalleryItemInSupabase(testData || defaultData);
            };
            window.testLoadGallery = () => window.adminDashboard.loadGallery();
            window.testLoadCategories = () => window.adminDashboard.getGalleryCategoriesFromSupabase();
            window.testLoadItems = () => window.adminDashboard.getGalleryFromSupabase();

            console.log('🔍 DEBUG: Gallery debug functions available:');
            console.log('  - debugGallery() - Run comprehensive gallery system debug');
            console.log('  - testGalleryCreate(data) - Test gallery item creation');
            console.log('  - testLoadGallery() - Test full gallery loading');
            console.log('  - testLoadCategories() - Test category loading only');
            console.log('  - testLoadItems() - Test gallery items loading only');
        });
    </script>
